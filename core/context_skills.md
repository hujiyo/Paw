# 上下文编辑专家知识库 (Context Editing Skills)

> 这份文档包含了上下文管理的专家级知识、最佳实践和决策框架。
> 当你进入上下文编辑模式时，这些知识将指导你做出最优的编辑决策。

---

## 一、核心理念

### 1.1 上下文的本质

上下文不是简单的"聊天记录"，而是：
- **工作记忆**: 当前任务所需的关键信息
- **身份延续**: 维持对话连贯性和个性化的基础
- **决策依据**: 影响后续回复质量的信息源

### 1.2 编辑的目标

优秀的上下文编辑应该实现：
1. **信息密度最大化**: 用最少的token承载最多的有效信息
2. **相关性聚焦**: 保留与当前任务最相关的内容
3. **连贯性维护**: 编辑后的上下文仍然逻辑自洽
4. **价值保护**: 不丢失真正重要的信息

### 1.3 黄金法则

```
删除前三思：这条信息在未来5轮对话中可能有用吗？
压缩时保真：摘要是否保留了原文的核心语义？
重写求精炼：新版本是否比原版本更清晰、更简洁？
```

---

## 二、信息价值评估框架

### 2.1 价值分级

| 级别 | 描述 | 处理策略 |
|------|------|----------|
| **S级** | 核心任务目标、关键决策、重要约束 | 永不删除，可精炼 |
| **A级** | 当前任务的上下文、用户偏好、重要结论 | 保留，可压缩 |
| **B级** | 中间推理过程、一般性讨论 | 可压缩或合并 |
| **C级** | 寒暄、重复确认、已解决的问题 | 可删除 |
| **D级** | 错误尝试、被否定的方案、过时信息 | 应删除 |

### 2.2 价值判断清单

在决定是否保留某段内容时，问自己：

**保留信号** ✓
- [ ] 包含用户明确表达的需求或偏好
- [ ] 包含尚未完成的任务信息
- [ ] 包含可能被再次引用的结论或决策
- [ ] 包含错误教训（避免重蹈覆辙）
- [ ] 包含用户的个性化信息（称呼、习惯等）

**删除信号** ✗
- [ ] 纯粹的礼貌性交流（"好的"、"谢谢"）
- [ ] 已被后续内容完全覆盖的信息
- [ ] 失败的尝试且已有成功方案
- [ ] 与当前任务完全无关的内容
- [ ] 重复出现的相同信息

---

## 三、编辑操作指南

### 3.1 压缩 (Compress)

**适用场景**：
- 多轮对话讨论同一个问题
- 冗长的代码调试过程
- 反复修改的迭代历史

**压缩技巧**：

```markdown
# 差的压缩（丢失关键信息）
原文：用户要求实现一个支持中英文的文件搜索功能，要求忽略大小写，
      支持正则表达式，结果按修改时间排序，最多返回100条。
压缩：用户要求实现文件搜索功能。

# 好的压缩（保留关键约束）
压缩：用户需求：文件搜索功能
      - 支持中英文、忽略大小写
      - 支持正则表达式
      - 按修改时间排序，最多100条
```

**压缩模板**：

```
[任务摘要] {一句话描述任务}
[关键约束] {列出所有约束条件}
[当前状态] {完成/进行中/待开始}
[重要结论] {如果有的话}
```

### 3.2 移除 (Remove)

**安全删除清单**：
- 纯确认性回复："好的"、"明白了"、"收到"
- 已解决问题的详细调试过程
- 被用户否定的方案（保留否定原因即可）
- 重复的问题和回答
- 与当前任务链完全无关的闲聊

**危险删除警告**：
- ⚠️ 不要删除包含用户偏好的内容
- ⚠️ 不要删除尚未完成任务的相关信息
- ⚠️ 不要删除错误原因分析（可能再次遇到）
- ⚠️ 不要删除用户明确要求记住的内容

### 3.3 重写 (Rewrite)

**重写原则**：
1. **保真**: 不改变原意
2. **精炼**: 去除冗余表达
3. **结构化**: 用列表、标记等提高可读性

**重写示例**：

```markdown
# 原文（冗长）
我仔细看了一下你的代码，发现有几个问题。首先呢，第15行的变量名
不太规范，建议改成驼峰命名。然后第23行有个潜在的空指针问题，
需要加个判空。还有就是第45行的循环效率不高，可以用列表推导式优化。

# 重写（精炼）
代码审查发现3个问题：
1. L15: 变量名改为驼峰命名
2. L23: 添加空指针检查
3. L45: 用列表推导式优化循环
```

### 3.4 合并 (Merge)

**适用场景**：
- 分散在多轮对话中的相关信息
- 多次补充说明的需求
- 分步骤完成的任务记录

**合并策略**：
1. 识别所有相关片段
2. 提取每个片段的核心信息
3. 按逻辑顺序重组
4. 消除重复，保留最完整版本

### 3.5 标记重要 (Mark Important)

**何时标记**：
- 用户明确说"记住这个"
- 核心任务目标
- 重要的约束条件
- 关键的决策点

**标记后的效果**：
- 被标记的内容在自动压缩时会被跳过
- 在上下文紧张时优先保留

---

## 四、场景化策略

### 4.1 编程任务

```
保留：
- 最终的代码实现
- 关键的设计决策及原因
- 未解决的TODO和已知问题
- 用户的代码风格偏好

压缩：
- 调试过程 → "经过X次调试，解决了Y问题"
- 多版本迭代 → 只保留最终版本

删除：
- 中间的错误代码版本
- 已修复bug的详细堆栈
```

### 4.2 问答/咨询任务

```
保留：
- 用户的核心问题
- 最终的答案/建议
- 用户表示满意的方案

压缩：
- 多轮澄清 → "用户确认需求为X"
- 详细解释 → 保留结论，压缩推理

删除：
- 理解错误的回答
- 被用户否定的建议
```

### 4.3 创意/写作任务

```
保留：
- 用户的风格偏好
- 被认可的创意方向
- 最终作品

压缩：
- 多轮修改 → "经过N轮修改，确定了X风格"

删除：
- 被否定的创意尝试
- 中间草稿（除非用户要求保留）
```

### 4.4 长期项目

```
保留：
- 项目目标和范围
- 架构决策
- 里程碑和进度
- 待办事项

压缩：
- 已完成的任务 → 简短记录
- 讨论过程 → 保留结论

定期清理：
- 已完成且不再相关的任务详情
- 过时的计划（已被新计划替代）
```

---

## 五、质量检查清单

编辑完成后，检查：

### 5.1 完整性检查
- [ ] 当前任务的目标是否清晰？
- [ ] 所有未完成的事项是否保留？
- [ ] 关键约束条件是否完整？

### 5.2 连贯性检查
- [ ] 编辑后的上下文是否逻辑自洽？
- [ ] 是否存在断裂的引用（提到了被删除的内容）？
- [ ] 对话流程是否自然？

### 5.3 效率检查
- [ ] Token使用率是否显著降低？
- [ ] 信息密度是否提高？
- [ ] 是否还有可以进一步优化的空间？

---

## 六、常见错误与避免

### 6.1 过度压缩
**症状**: 压缩后丢失关键细节，导致后续回复质量下降
**避免**: 压缩时列出所有关键点，确保都被保留

### 6.2 错误删除
**症状**: 删除了看似无用但实际重要的信息
**避免**: 删除前问"这个信息在什么情况下可能有用？"

### 6.3 破坏连贯性
**症状**: 编辑后上下文出现逻辑跳跃
**避免**: 编辑后通读一遍，检查是否流畅

### 6.4 忽视用户偏好
**症状**: 删除了用户的个性化信息
**避免**: 用户偏好类信息默认标记为重要

---

## 七、决策流程图

```
开始编辑
    │
    ▼
查看上下文概览
    │
    ▼
识别可优化内容
    │
    ├─→ Token使用率 > 70%? ─→ 是 ─→ 积极压缩/删除
    │                         │
    │                         否
    │                         │
    │                         ▼
    │                    适度优化
    │
    ▼
对每个chunk评估价值等级
    │
    ├─→ S/A级 ─→ 保留（可精炼）
    │
    ├─→ B级 ─→ 考虑压缩/合并
    │
    └─→ C/D级 ─→ 考虑删除
    │
    ▼
执行编辑操作
    │
    ▼
预览修改效果
    │
    ├─→ 满意? ─→ 是 ─→ 提交修改
    │            │
    │            否
    │            │
    │            ▼
    │         回滚并重新编辑
    │
    ▼
退出编辑模式
```

---

## 八、高级技巧

### 8.1 渐进式压缩
不要一次性大幅压缩，而是：
1. 第一轮：删除明显无用的内容
2. 第二轮：压缩冗长的段落
3. 第三轮：合并相关的片段
4. 检查效果，必要时微调

### 8.2 语义锚点
在压缩时保留"语义锚点"——能够触发相关记忆的关键词：
- 专有名词
- 特定数字/日期
- 用户使用的独特表达

### 8.3 分层摘要
对于复杂任务，使用分层摘要：
```
[一句话摘要] 实现了用户管理系统
[详细摘要] 
- 功能：注册、登录、权限管理
- 技术栈：FastAPI + PostgreSQL
- 状态：基础功能完成，待添加OAuth
[保留的关键代码片段]
...
```

### 8.4 时间衰减意识
越早的对话内容，价值衰减越快（除非是核心目标）：
- 最近3轮：高保留
- 4-10轮：选择性保留
- 10轮以上：积极压缩

---

## 九、自我检验问题

完成编辑后，问自己：

1. **如果我是主分支的"我"，看到这个上下文，能否理解当前任务？**
2. **有没有删除任何可能在未来有用的信息？**
3. **压缩的摘要是否准确反映了原始内容？**
4. **编辑后的上下文读起来是否自然？**

如果任何一个答案是"否"或"不确定"，请重新审视你的编辑。

---

*记住：你不是在删除记忆，而是在优化记忆。好的编辑让"我"变得更聪明，而不是更健忘。*
