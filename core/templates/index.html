<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paw</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.css">
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
    </script>
    <link rel="stylesheet" href="/static/css/main.css?v=1.0.3">
</head>
<body>
    <div id="app-shell">
        <aside class="sidebar">
            <!-- 视图切换标签 -->
            <div class="sidebar__tabs">
                <button class="sidebar__tab sidebar__tab--active" data-view="history">历史对话</button>
                <button class="sidebar__tab" data-view="memory">记忆</button>
            </div>

            <!-- 历史对话视图 -->
            <div class="sidebar__view sidebar__view--active" id="view-history">
                <div class="history-header">
                    <button class="history-new-btn" id="new-chat-btn">+ 新对话</button>
                </div>
                <div class="history-list" id="history-list">
                    <div class="history-empty" id="history-empty">暂无历史对话</div>
                </div>
            </div>


            <!-- 记忆管理视图 -->
            <div class="sidebar__view" id="view-memory">
                <div class="memory-header">
                    <div class="memory-header__title">记忆管理</div>
                    <div class="memory-header__actions">
                        <button class="memory-btn" id="memory-search-btn">🔍</button>
                        <button class="memory-btn" id="memory-clean-btn">🧹</button>
                    </div>
                </div>
                <div class="memory-stats" id="memory-stats">共 0 条记忆</div>
                <div class="memory-canvas" id="memory-canvas">
                    <div class="memory-empty" id="memory-empty">/memory edit 进入管理</div>
                </div>
            </div>

            <!-- 侧边栏底部 -->
            <div class="sidebar__footer">
                <button class="settings-btn" id="settings-open-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    设置
                </button>
            </div>
        </aside>

        <main class="main">
            <!-- 顶部工具栏 -->
            <div class="toolbar">
                <div class="toolbar__left-group">
                    <button class="toolbar__btn" id="toggle-sidebar" title="切换侧边栏 (Ctrl+B)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M4 2h10a1 1 0 011 1v10a1 1 0 01-1 1H4a1 1 0 01-1-1V3a1 1 0 011-1zm0 1v10h3V3H4zm4 0v10h6V3H8z"/>
                        </svg>
                    </button>
                    <!-- 工作区文件目录侧边栏按钮：当右侧边栏打开时显示 -->
                    <button class="toolbar__btn" id="toggle-workspace-files-sidebar" title="工作区文件 (Ctrl+Shift+E)" style="display:none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                            <polyline points="13 2 13 9 20 9"></polyline>
                        </svg>
                    </button>
                    <div class="toolbar__divider" id="toolbar-divider"></div>
                    <button class="toolbar__btn" id="new-chat-toolbar" title="新对话 (Ctrl+N)">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 2a6 6 0 100 12A6 6 0 008 2zm0 1a5 5 0 110 10A5 5 0 018 3zm.5 2.5a.5.5 0 00-1 0v2h-2a.5.5 0 000 1h2v2a.5.5 0 001 0v-2h2a.5.5 0 000-1h-2v-2z"/>
                        </svg>
                    </button>
                    <button class="toolbar__btn toolbar__btn--active" id="chat-view-btn" title="聊天">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                    <button class="toolbar__btn" id="skills-market-btn" title="Skills">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                    </button>
                </div>
                <div class="toolbar__spacer" style="flex:1"></div>
                <button class="toolbar__btn" id="toggle-right-sidebar" title="工作区 (Ctrl+E)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="15" y1="3" x2="15" y2="21"></line>
                    </svg>
                </button>
            </div>

            <!-- 聊天视图 -->
            <div id="chat-view" class="chat-view chat-view--active">
                <div class="status-bar" id="status-bar"></div>
                <div class="messages-wrapper" id="messages-wrapper">
                    <div class="messages" id="messages"></div>
                </div>
                <div class="input-area">
                    <div class="input-wrap">
                        <form class="input-form" id="input-form">
                            <textarea id="input" placeholder="Ask Paw anything..." rows="1"></textarea>
                            <button type="submit" id="send-btn">Send</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Skill商城界面 -->
            <div id="skills-market-view" class="skills-market-view">
                <div class="skills-market-container">
                    <div class="skills-market-header">
                        <div class="skills-market-header__title">Skills</div>
                        <!-- 关闭按钮已移除 -->
                    </div>
                    
                    <!-- 切换标签 -->
                    <div class="skills-market-tabs">
                        <button class="skills-market-tab skills-market-tab--active" data-skills-view="market">市场</button>
                        <button class="skills-market-tab" data-skills-view="installed">已安装</button>
                    </div>
                    
                    <!-- 市场视图 -->
                    <div class="skills-market-content skills-market-content--active" id="skills-market-content">
                        <div class="skills-search-bar">
                            <input type="text" class="skills-search" id="skills-search-input" placeholder="搜索 skills..." />
                            <select class="skills-category" id="skills-category-select">
                                <option value="">所有分类</option>
                                <option value="development">开发</option>
                                <option value="creative">创意</option>
                                <option value="enterprise">企业</option>
                                <option value="documentation">文档</option>
                            </select>
                            <button class="skills-search-btn" id="skills-search-btn">🔍</button>
                        </div>
                        <div class="skills-list" id="skills-list">
                            <div class="skills-empty">
                                <div class="skills-empty__icon">📦</div>
                                <div class="skills-empty__text">点击搜索按钮浏览 Skills</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 已安装视图 -->
                    <div class="skills-market-content" id="skills-installed-content">
                        <div class="installed-list" id="installed-list">
                            <div class="skills-empty">
                                <div class="skills-empty__icon">💭</div>
                                <div class="skills-empty__text">暂未安装任何 Skill</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 编辑器配置界面 -->
            <div id="editor-settings-view" class="editor-settings-view">
                <div class="editor-settings-container">
                    <div class="editor-settings-header">
                        <div class="editor-settings-header__title">编辑器设置</div>
                        <button class="editor-settings-header__close" id="editor-settings-close-btn">&times;</button>
                    </div>
                    <div class="editor-settings-content">
                        <div class="settings__section">
                            <div class="settings__section-title">外观</div>
                            <div class="settings__field">
                                <label class="settings__label">颜色主题</label>
                                <select class="settings__select" id="es-theme">
                                    <option value="vs-dark">Dark (Visual Studio)</option>
                                    <option value="vs">Light (Visual Studio)</option>
                                    <option value="hc-black">High Contrast Dark</option>
                                </select>
                            </div>
                            <div class="settings__field">
                                <label class="settings__label">字体大小</label>
                                <input type="number" class="settings__input" id="es-fontSize" min="10" max="32" value="14">
                            </div>
                            <div class="settings__field">
                                <label class="settings__label">显示行号</label>
                                <div class="settings__checkbox-group">
                                    <input type="checkbox" class="settings__checkbox" id="es-lineNumbers" checked>
                                    <span class="settings__hint">显示左侧行号</span>
                                </div>
                            </div>
                            <div class="settings__field">
                                <label class="settings__label">小地图 (Minimap)</label>
                                <div class="settings__checkbox-group">
                                    <input type="checkbox" class="settings__checkbox" id="es-minimap" checked>
                                    <span class="settings__hint">显示右侧代码概览</span>
                                </div>
                            </div>
                        </div>
                        <div class="settings__section">
                            <div class="settings__section-title">编辑器行为</div>
                            <div class="settings__field">
                                <label class="settings__label">自动换行 (Word Wrap)</label>
                                <select class="settings__select" id="es-wordWrap">
                                    <option value="off">关闭 (Off)</option>
                                    <option value="on">开启 (On)</option>
                                    <option value="wordWrapColumn">按列换行 (Wrap at Column)</option>
                                    <option value="bounded">边界换行 (Bounded)</option>
                                </select>
                            </div>
                            <div class="settings__field">
                                <label class="settings__label">Tab 大小</label>
                                <input type="number" class="settings__input" id="es-tabSize" min="2" max="8" value="4">
                            </div>
                            <div class="settings__field">
                                <label class="settings__label">空白字符渲染</label>
                                <select class="settings__select" id="es-renderWhitespace">
                                    <option value="selection">仅选中时 (Selection)</option>
                                    <option value="none">不显示 (None)</option>
                                    <option value="all">始终显示 (All)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <aside class="sidebar-right" id="sidebar-right">
            <!-- VSCode 风格标签页栏 -->
            <div class="editor-tabs" id="editor-tabs">
                <!-- 常驻标签页 -->
                <div class="editor-tab editor-tab--pinned editor-tab--active" data-tab-id="terminal" data-pinned="true">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                    <span class="editor-tab__title">Terminal</span>
                </div>
                <div class="editor-tab editor-tab--pinned" data-tab-id="plan" data-pinned="true">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    <span class="editor-tab__title">Plan</span>
                </div>
                <div class="editor-tab editor-tab--pinned" data-tab-id="browser" data-pinned="true">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                    </svg>
                    <span class="editor-tab__title">Web</span>
                </div>
                <!-- 文件标签页将动态添加在这里 -->
            </div>

            <!-- 标签页内容区 -->
            <div class="editor-panels" id="editor-panels">
                <!-- 终端输出视图 -->
                <div class="editor-panel editor-panel--active" id="panel-terminal">
                    <div class="workspace-header">
                        <div class="workspace-header__title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 17 10 11 4 5"></polyline>
                                <line x1="12" y1="19" x2="20" y2="19"></line>
                            </svg>
                            终端
                        </div>
                        <div class="workspace-header__status" id="terminal-status">未打开</div>
                    </div>
                    <div class="terminal-output" id="terminal-output">
                        <pre class="terminal-output__content" id="terminal-content">Paw 未打开终端</pre>
                    </div>
                </div>

                <!-- 计划/任务视图 -->
                <div class="editor-panel" id="panel-plan">
                    <div class="workspace-header">
                        <div class="workspace-header__title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            任务计划
                        </div>
                    </div>
                    <div class="plan-list" id="plan-list">
                        <div class="plan-empty">暂无活动任务</div>
                    </div>
                </div>

                <!-- 浏览器/Web工具视图 -->
                <div class="editor-panel" id="panel-browser">
                    <!-- 主界面：URL收集列表 -->
                    <div class="browser-view browser-view--main" id="browser-main-view">
                        <div class="workspace-header">
                            <div class="workspace-header__title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                                URL收集
                                <span class="browser-url-count" id="browser-url-count">0</span>
                            </div>
                        </div>
                        <div class="browser-results" id="browser-results">
                            <div class="browser-empty">
                                <div class="browser-empty__icon">🌐</div>
                                <div class="browser-empty__text">暂无URL</div>
                                <div class="browser-empty__hint">对话中出现的URL会自动收集到这里</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 次级界面：网页预览 -->
                    <div class="browser-view browser-view--detail" id="browser-detail-view" style="display:none;">
                        <div class="workspace-header">
                            <div class="workspace-header__title">
                                <button id="browser-back-btn" class="icon-btn" title="返回搜索结果">←</button>
                                <span class="browser-detail-title" id="browser-detail-title">网页预览</span>
                            </div>
                            <div class="browser-actions">
                                <button id="browser-external-btn" class="icon-btn" title="在系统浏览器打开">🔗</button>
                            </div>
                        </div>
                        <div class="browser-controls browser-controls--detail">
                            <input type="text" id="browser-url" class="browser-url-input" placeholder="https://...">
                            <button id="browser-go" class="icon-btn">Go</button>
                        </div>
                        <div class="browser-container">
                            <iframe id="browser-frame" src="about:blank"></iframe>
                        </div>
                    </div>
                </div>

                <!-- 文件预览面板将动态添加在这里 -->
            </div>
        </aside>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal">
            <div id="modal-title" class="modal__header">选择模型</div>
            <div id="modal-body" class="modal__body"></div>
            <div id="modal-actions" class="modal__actions" style="display:none;">
                <button id="modal-ok" class="modal__btn">确定</button>
            </div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
            <div id="confirm-title" class="modal__header">确认</div>
            <div id="confirm-body" class="modal__body"></div>
            <div class="modal__actions">
                <button id="confirm-cancel" class="settings__btn settings__btn--secondary">取消</button>
                <button id="confirm-ok" class="settings__btn settings__btn--primary" style="background:var(--error-color);color:#fff">删除</button>
            </div>
        </div>
    </div>


    <!-- 新建对话配置界面 -->
    <div id="new-chat-view" class="new-chat-view">
        <div class="new-chat-container">
            <div class="new-chat-header">
                <div class="new-chat-header__title">创建新对话</div>
                <button class="new-chat-header__close" id="new-chat-close-btn">&times;</button>
            </div>
            <div class="new-chat-content">
                <div class="settings__field">
                    <label class="settings__label">工作区目录</label>
                    <div class="settings__input-with-btn">
                        <input type="text" class="settings__input" id="new-chat-workspace" placeholder="输入或选择目录">
                        <button type="button" class="settings__btn settings__btn--secondary" id="new-chat-browse-btn">浏览...</button>
                    </div>
                    <div class="settings__hint">当前对话的工作目录，默认为用户主目录</div>
                    
                    <!-- 最近工作区列表 -->
                    <div class="recent-workspaces" id="recent-workspaces" style="display:none;">
                        <div class="recent-workspaces__title">最近使用:</div>
                        <div class="recent-workspaces__list" id="recent-workspaces-list"></div>
                    </div>
                </div>

                <div class="settings__field">
                    <label class="settings__label">对话名称 (可选)</label>
                    <input type="text" class="settings__input" id="new-chat-title" placeholder="留空则自动生成">
                    <div class="settings__hint">为本次对话起个名字，方便后续查找</div>
                </div>

                <div class="settings__field">
                    <label class="settings__label">选择模型</label>
                    <div class="model-select" id="new-chat-model-select">
                        <div class="model-select__trigger" id="new-chat-model-trigger">
                            <span class="model-select__value" id="new-chat-model-value">使用全局默认</span>
                            <span class="model-select__arrow">▼</span>
                        </div>
                        <div class="model-select__dropdown" id="new-chat-model-dropdown">
                            <div class="model-select__option" data-value="">使用全局默认</div>
                            <div class="model-select__loading" id="new-chat-model-loading" style="display:none">加载中...</div>
                            <div class="model-select__error" id="new-chat-model-error" style="display:none"></div>
                            <div class="model-select__manual" id="new-chat-model-manual">
                                <input type="text" class="model-select__input" id="new-chat-model-input" placeholder="或输入自定义模型">
                                <button class="model-select__add" id="new-chat-model-add">确定</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="new-chat-model" value="">
                    <div class="settings__hint">点击获取可用模型，或输入自定义模型名</div>
                </div>

                <div class="settings__field">
                    <label class="settings__label">系统提示词 (可选)</label>
                    <textarea class="settings__textarea" id="new-chat-system-prompt" placeholder="留空则使用默认系统提示词" rows="6"></textarea>
                    <div class="settings__hint">自定义系统提示词，留空则使用默认配置</div>
                </div>
            </div>
            <div class="new-chat-footer">
                <button class="settings__btn settings__btn--secondary" id="new-chat-cancel-btn">取消</button>
                <button class="settings__btn settings__btn--primary" id="new-chat-create-btn">创建</button>
            </div>
        </div>
    </div>

    <!-- 配置面板 -->
    <div id="settings-overlay" class="settings-overlay"></div>
    <div id="settings-panel" class="settings-panel">
        <div class="settings__header">
            <div class="settings__title">设置</div>
            <button class="settings__close" id="settings-close-btn">&times;</button>
        </div>
        <div class="settings__content">
            <!-- 身份配置 -->
            <div class="settings__section">
                <div class="settings__section-title">身份</div>
                <div class="settings__field">
                    <label class="settings__label">AI 昵称</label>
                    <input type="text" class="settings__input" id="cfg-name" placeholder="Paw">
                </div>
                <div class="settings__field">
                    <label class="settings__label">用户名</label>
                    <input type="text" class="settings__input" id="cfg-username" placeholder="hujiyo">
                </div>
                <div class="settings__field">
                    <label class="settings__label">用户昵称</label>
                    <input type="text" class="settings__input" id="cfg-honey" placeholder="老公">
                </div>
            </div>

            <!-- API 配置 -->
            <div class="settings__section">
                <div class="settings__section-title">API</div>
                <div class="settings__field">
                    <label class="settings__label">API Key</label>
                    <input type="password" class="settings__input" id="cfg-api-key" placeholder="输入 API Key">
                </div>
                <div class="settings__field">
                    <label class="settings__label">API 地址</label>
                    <input type="text" class="settings__input" id="cfg-api-url" placeholder="https://api.example.com/v1/chat/completions">
                </div>
                <div class="settings__field">
                    <label class="settings__label">默认模型</label>
                    <div class="model-select" id="model-select">
                        <div class="model-select__trigger" id="model-select-trigger">
                            <span class="model-select__value" id="model-select-value">留空则启动时选择</span>
                            <span class="model-select__arrow">▼</span>
                        </div>
                        <div class="model-select__dropdown" id="model-select-dropdown">
                            <div class="model-select__option" data-value="">留空 (启动时选择)</div>
                            <div class="model-select__loading" id="model-select-loading" style="display:none">加载中...</div>
                            <div class="model-select__error" id="model-select-error" style="display:none"></div>
                            <div class="model-select__manual" id="model-select-manual">
                                <input type="text" class="model-select__input" id="model-select-input" placeholder="或输入自定义模型">
                                <button class="model-select__add" id="model-select-add">确定</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="cfg-model" value="">
                    <div class="settings__hint">点击获取可用模型，或输入自定义模型名</div>
                </div>
            </div>

            <!-- 终端配置 -->
            <div class="settings__section">
                <div class="settings__section-title">终端</div>
                <div class="settings__field">
                    <label class="settings__label">Shell 类型</label>
                    <select class="settings__select" id="cfg-shell">
                        <option value="powershell">PowerShell (Windows)</option>
                        <option value="cmd">CMD (Windows)</option>
                        <option value="bash">Bash (Linux/Mac)</option>
                        <option value="zsh">Zsh (Mac)</option>
                    </select>
                </div>
                <div class="settings__field">
                    <label class="settings__label">字符编码</label>
                    <input type="text" class="settings__input" id="cfg-encoding" placeholder="utf-8">
                </div>
                <div class="settings__field">
                    <label class="settings__label">输出缓冲区大小 (KB)</label>
                    <input type="number" class="settings__input" id="cfg-buffer-size" min="4" max="64" value="24">
                    <div class="settings__hint">终端输出缓冲区上限，范围 4-64 KB，默认 24 KB</div>
                </div>
            </div>

            <!-- Web 配置 -->
            <div class="settings__section">
                <div class="settings__section-title">Web 工具</div>
                <div class="settings__field">
                    <label class="settings__label">搜索引擎</label>
                    <select class="settings__select" id="cfg-search-engine">
                        <option value="duckduckgo">DuckDuckGo (免费)</option>
                    </select>
                </div>
                <div class="settings__field">
                    <label class="settings__label">最大搜索结果数</label>
                    <input type="number" class="settings__input" id="cfg-max-results" min="1" max="20" value="5">
                </div>
                <div class="settings__field">
                    <label class="settings__label">使用 Jina Reader</label>
                    <div class="settings__checkbox-group">
                        <input type="checkbox" class="settings__checkbox" id="cfg-use-jina">
                        <span class="settings__hint">启用后可抓取动态网页内容</span>
                    </div>
                </div>
            </div>

            <!-- 系统配置 -->
            <div class="settings__section">
                <div class="settings__section-title">系统</div>
                <div class="settings__field">
                    <label class="settings__label">Home 工作目录</label>
                    <div class="settings__input-with-btn">
                        <input type="text" class="settings__input" id="cfg-home-dir" placeholder="留空则使用系统主目录 (~)">
                        <button type="button" class="settings__btn settings__btn--secondary" id="cfg-home-dir-browse-btn">浏览...</button>
                    </div>
                    <div class="settings__hint">默认工作目录，新建对话时的默认值，留空则使用系统主目录</div>
                </div>
                <div class="settings__field">
                    <label class="settings__label">上下文窗口大小 (token)</label>
                    <input type="number" class="settings__input" id="cfg-chunk-size" min="1000" max="200000" step="1000" value="64000">
                </div>
            </div>

            <!-- 记忆系统配置 -->
            <div class="settings__section">
                <div class="settings__section-title">记忆系统</div>
                <div class="settings__field">
                    <label class="settings__label">启用记忆系统</label>
                    <div class="settings__checkbox-group">
                        <input type="checkbox" class="settings__checkbox" id="cfg-memory-enabled">
                        <span class="settings__hint">启用后可记住历史对话，需要配置 Embedding 服务</span>
                    </div>
                </div>
                <div id="memory-config-fields" class="settings__collapsible" style="display:none;">
                    <div class="settings__field">
                        <label class="settings__label">Embedding URL</label>
                        <select class="settings__select" id="cfg-embedding-url-preset">
                            <option value="ollama">Ollama (http://localhost:11434/api/embeddings)</option>
                            <option value="lm_studio">LM Studio (http://localhost:1234/v1/embeddings)</option>
                            <option value="custom">自定义 URL...</option>
                        </select>
                        <input type="text" class="settings__input" id="cfg-embedding-url" placeholder="http://localhost:11434/api/embeddings" style="margin-top:8px;">
                        <div class="settings__hint">选择预设或输入自定义 Embedding API 地址</div>
                    </div>
                    <div class="settings__field">
                        <label class="settings__label">API Key</label>
                        <input type="password" class="settings__input" id="cfg-embedding-key" placeholder="本地服务可留空">
                        <div class="settings__hint">本地 Ollama/LM Studio 无需填写，远程 API 需要填写</div>
                    </div>
                    <div class="settings__field">
                        <label class="settings__label">默认模型</label>
                        <div class="model-select" id="embed-model-select">
                            <div class="model-select__trigger" id="embed-model-select-trigger">
                                <span class="model-select__value" id="embed-model-select-value">留空或选择模型</span>
                                <span class="model-select__arrow">▼</span>
                            </div>
                            <div class="model-select__dropdown" id="embed-model-select-dropdown">
                                <div class="model-select__option" data-value="nomic-embed-text">nomic-embed-text (Ollama默认)</div>
                                <div class="model-select__option" data-value="mxbai-embed-large">mxbai-embed-large (推荐)</div>
                                <div class="model-select__option" data-value="text-embedding-3-small">text-embedding-3-small (OpenAI)</div>
                                <div class="model-select__loading" id="embed-model-select-loading" style="display:none">加载中...</div>
                                <div class="model-select__error" id="embed-model-select-error" style="display:none"></div>
                                <div class="model-select__manual" id="embed-model-select-manual">
                                    <input type="text" class="model-select__input" id="embed-model-select-input" placeholder="或输入自定义模型">
                                    <button class="model-select__add" id="embed-model-select-add">确定</button>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="cfg-embedding-model" value="">
                        <div class="settings__hint">点击获取可用模型，或输入自定义模型名</div>
                    </div>
                    <div class="settings__field">
                        <label class="settings__label">回忆意图阈值</label>
                        <div class="settings__input-with-btn">
                            <input type="number" class="settings__input" id="cfg-recall-threshold" placeholder="0.35" step="0.01" min="0" max="1" value="0.35">
                            <button type="button" class="settings__btn settings__btn--small" id="btn-calibrate-threshold">推荐</button>
                        </div>
                        <div class="settings__hint">越高越不容易触发回忆，点击"推荐"自动计算最佳阈值</div>
                        <div id="calibrate-status" class="settings__status" style="display:none;"></div>
                    </div>
                </div>
            </div>

            <!-- 颜色主题配置 -->
            <div class="settings__section">
                <div class="settings__section-title">颜色主题</div>

                <div class="settings__field">
                    <label class="settings__label">主题样式</label>
                    <div class="theme-selector" id="theme-selector">
                        <div class="theme-option" data-theme="yaoye" style="background:#252525;border-color:#444">
                            <div class="theme-option__preview">
                                <div class="theme-option__color theme-option__color--titlebar" style="background:#000000"></div>
                                <div class="theme-option__color theme-option__color--loading" style="background:#000000"></div>
                                <div class="theme-option__color theme-option__color--main" style="background:#000000"></div>
                            </div>
                            <div class="theme-option__info">
                                <div class="theme-option__name" style="color:#eee">耀夜</div>
                                <div class="theme-option__desc" style="color:#888">深邃黑</div>
                            </div>
                        </div>
                        <div class="theme-option" data-theme="shuangbai" style="background:#ffffff;border-color:#e5e5e5">
                            <div class="theme-option__preview">
                                <div class="theme-option__color theme-option__color--titlebar" style="background:#FFFFFF;border-color:#ddd"></div>
                                <div class="theme-option__color theme-option__color--loading" style="background:#FFFFFF;border-color:#ddd"></div>
                                <div class="theme-option__color theme-option__color--main" style="background:#FFFFFF;border-color:#ddd"></div>
                            </div>
                            <div class="theme-option__info">
                                <div class="theme-option__name" style="color:#333">霜白</div>
                                <div class="theme-option__desc" style="color:#666">纯净白</div>
                            </div>
                        </div>
                        <div class="theme-option" data-theme="taoxi" style="background:#fff0f5;border-color:#ffd6e0">
                            <div class="theme-option__preview">
                                <div class="theme-option__color theme-option__color--titlebar" style="background:#FFFFFF;border-color:#ffd1dc"></div>
                                <div class="theme-option__color theme-option__color--loading" style="background:#FFD6E0"></div>
                                <div class="theme-option__color theme-option__color--main" style="background:#FFF0F5"></div>
                            </div>
                            <div class="theme-option__info">
                                <div class="theme-option__name" style="color:#d63384">桃汐</div>
                                <div class="theme-option__desc" style="color:#d63384">温柔淡粉</div>
                            </div>
                        </div>
                        <div class="theme-option" data-theme="cuimo" style="background:#022c22;border-color:#064e3b">
                            <div class="theme-option__preview">
                                <div class="theme-option__color theme-option__color--titlebar" style="background:#000000;border-color:#065f46"></div>
                                <div class="theme-option__color theme-option__color--loading" style="background:#000000;border-color:#065f46"></div>
                                <div class="theme-option__color theme-option__color--main" style="background:#000000;border-color:#065f46"></div>
                            </div>
                            <div class="theme-option__info">
                                <div class="theme-option__name" style="color:#10b981">翠墨</div>
                                <div class="theme-option__desc" style="color:#059669">深邃墨绿</div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="cfg-theme" value="yaoye">
                </div>
            </div>
        </div>
        <div class="settings__footer">
            <button class="settings__btn settings__btn--secondary" id="settings-reset-btn">重置</button>
            <button class="settings__btn settings__btn--primary" id="settings-save-btn">保存配置</button>
        </div>
    </div>

    <!-- 提示消息 -->
    <div id="settings-toast" class="settings__toast"></div>

    <!-- 工具详情弹窗 -->
    <div id="tool-detail-modal" class="tool-detail-modal">
        <div class="tool-detail-modal__content">
            <div class="tool-detail-modal__header">
                <div class="tool-detail-modal__title">
                    <span class="tool-detail-modal__title-icon">⚙️</span>
                    <span id="tool-detail-title">工具调用详情</span>
                </div>
                <button class="tool-detail-modal__close" id="tool-detail-close">&times;</button>
            </div>
            <div class="tool-detail-modal__body" id="tool-detail-body">
                <!-- LLM 请求区域 -->
                <div class="tool-detail-section">
                    <div class="tool-detail-section__title">
                        <span>LLM 请求</span>
                        <span class="tool-detail-section__title-badge">Request</span>
                    </div>
                    <div class="tool-detail-section__content" id="tool-detail-request">
                        <button class="tool-detail-copy-btn" data-copy="request">Copy</button>
                        <pre></pre>
                    </div>
                </div>
                
                <!-- 系统响应区域 -->
                <div class="tool-detail-section">
                    <div class="tool-detail-section__title">
                        <span>系统响应</span>
                        <span class="tool-detail-section__title-badge">Response</span>
                    </div>
                    <div class="tool-detail-section__content" id="tool-detail-response">
                        <button class="tool-detail-copy-btn" data-copy="response">Copy</button>
                        <pre></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 工作区文件目录侧边栏：覆盖层式，不挤压聊天区 -->
    <aside id="workspace-files-sidebar" class="workspace-files-sidebar">
        <div class="workspace-files-sidebar__header">
            <div class="workspace-files-sidebar__title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
                工作区文件
            </div>
            <div class="workspace-files-sidebar__actions">
                <button id="workspace-files-refresh-btn" class="icon-btn" title="刷新">↻</button>
                <button id="workspace-files-close-btn" class="workspace-files-sidebar__close">×</button>
            </div>
        </div>
        <div class="workspace-files-sidebar__content">
            <div class="file-tree" id="workspace-file-tree"></div>
        </div>
    </aside>

    <script type="module" src="/static/js/app.js?v=1.0.3"></script>
</body>
</html>
