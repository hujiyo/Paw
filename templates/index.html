<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paw</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.css">
    <style>
        :root {
            --font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            --bg-color: #000000;
            --bg-secondary: #0a0a0a;
            --text-primary: #EAEAEA;
            --text-secondary: #666666;
            --border-color: #333333;
            --accent-user: #80D1FF;
            --accent-assistant: #FF9E80;
            --accent-active: #50FA7B;
            --tool-color: #00FFFF;
            --error-color: #FF5555;
            --success-color: #50FA7B;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background: var(--bg-color); color: var(--text-primary); }
        #app-shell { display: flex; height: 100vh; }

        /* ===== ä¾§è¾¹æ  ===== */
        .sidebar {
            width: 280px;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }

        /* è§†å›¾åˆ‡æ¢æ ‡ç­¾ */
        .sidebar__tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar__tab {
            flex: 1;
            padding: 0.7rem 0.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .sidebar__tab:hover { color: var(--text-primary); }
        .sidebar__tab--active {
            color: var(--accent-assistant);
            border-bottom-color: var(--accent-assistant);
        }

        /* è§†å›¾å®¹å™¨ */
        .sidebar__view {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar__view--active { display: flex; }

        /* === å†å²å¯¹è¯è§†å›¾ === */
        .history-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .history-new-btn {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255,158,128,0.1);
            border: 1px dashed rgba(255,158,128,0.4);
            border-radius: 6px;
            color: var(--accent-assistant);
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-new-btn:hover { background: rgba(255,158,128,0.2); }
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .history-item {
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.35rem;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        .history-item:hover { background: rgba(255,255,255,0.05); }
        .history-item--active { background: rgba(255,158,128,0.12); }
        .history-item__title {
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.2rem;
        }
        .history-item__meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .history-item__delete {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            font-size: 0.9rem;
            padding: 0.2rem;
        }
        .history-item:hover .history-item__delete { opacity: 1; }
        .history-item__delete:hover { color: var(--error-color); }
        .history-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
            padding: 2rem 1rem;
        }

        /* === å¯¹è¯é“¾è§†å›¾ === */
        .chain-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .chain-header__title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }
        .chain-header__hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .chain-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .chain-item {
            padding: 0.5rem 0.6rem;
            border-radius: 5px;
            margin-bottom: 0.3rem;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.75rem;
            position: relative;
        }
        .chain-item:hover { background: rgba(255,255,255,0.05); }
        .chain-item--active { background: rgba(255,158,128,0.15); }
        .chain-item__role {
            font-size: 0.65rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .chain-item__role--user { color: var(--accent-user); }
        .chain-item__role--assistant { color: var(--accent-assistant); }
        .chain-item__text {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chain-item__clone {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            font-size: 0.9rem;
            padding: 0.2rem;
        }
        .chain-item:hover .chain-item__clone { opacity: 1; }
        .chain-item__clone:hover { color: var(--accent-assistant); }

        /* ===== è®°å¿†ç®¡ç† ===== */
        .memory-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .memory-header__title {
            font-size: 0.85rem;
            font-weight: 600;
        }
        .memory-header__actions {
            display: flex;
            gap: 0.4rem;
        }
        .memory-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .memory-btn:hover {
            border-color: var(--accent-assistant);
            color: var(--accent-assistant);
        }
        .memory-stats {
            padding: 0.4rem 0.75rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .memory-canvas {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .memory-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
            padding: 2rem 1rem;
        }
        .memory-item {
            padding: 0.5rem 0.6rem;
            border-radius: 5px;
            margin-bottom: 0.3rem;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.75rem;
            position: relative;
        }
        .memory-item:hover { background: rgba(255,255,255,0.05); }
        .memory-item--active { background: rgba(255,158,128,0.15); }
        .memory-item__msg {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.2rem;
        }
        .memory-item--active .memory-item__msg { color: var(--text-primary); }
        .memory-item__meta {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        .memory-item__delete {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            font-size: 0.9rem;
            padding: 0.2rem;
        }
        .memory-item:hover .memory-item__delete { opacity: 1; }
        .memory-item__delete:hover { color: var(--error-color); }
        .memory-item__checkbox {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ===== ä¸»å†…å®¹åŒº ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .main__header {
            padding: 1rem 0 0.5rem;
            text-align: center;
        }
        #logo {
            font-family: var(--font-family);
            font-size: 12px;
            line-height: 1.15;
            color: var(--accent-assistant);
            white-space: pre;
            text-shadow: 0 0 5px rgba(255, 158, 128, 0.5);
            margin: 0;
        }
        .status-bar {
            color: var(--text-secondary);
            text-align: center;
            padding: 0.4rem;
            font-size: 0.75rem;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .messages {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.25rem 1rem;
        }

        /* æ¶ˆæ¯ */
        .msg { margin-bottom: 1.25rem; }
        .msg__header {
            display: inline-block;
            font-weight: bold;
            padding: 0.15rem 0.5rem;
            margin-bottom: 0.35rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .msg--user .msg__header { background: var(--accent-user); color: #000; }
        .msg--assistant .msg__header { background: var(--accent-assistant); color: #000; }
        .msg__content { line-height: 1.65; padding-left: 0.4rem; }
        .msg__content pre {
            position: relative;
            background: #1a1a1a;
            padding: 0.65rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.8em;
            overflow-x: auto;
        }
        .msg__content code:not(pre > code) {
            background: rgba(255,158,128,0.1);
            color: var(--accent-assistant);
            padding: 0.1em 0.25em;
            border-radius: 3px;
        }
        .copy-btn {
            position: absolute;
            top: 0.35rem;
            right: 0.35rem;
            background: var(--border-color);
            color: var(--text-primary);
            border: none;
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0;
            font-size: 0.65rem;
        }
        .msg__content pre:hover .copy-btn { opacity: 1; }
        .sys-msg {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            padding: 0.25rem 0;
        }
        .sys-msg.error { color: var(--error-color); }

        /* å·¥å…·è°ƒç”¨ - Shell é£æ ¼ */
        .tool {
            margin: 0.5rem 0;
            font-size: 0.8rem;
            font-family: var(--font-family);
            line-height: 1.5;
        }
        .tool__header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .tool__spinner {
            width: 0.8em;
            height: 0.8em;
            border: 2px solid var(--tool-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.4rem;
            flex-shrink: 0;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tool__icon {
            margin-right: 0.4rem;
            min-width: 0.8em;
            flex-shrink: 0;
        }
        .tool__name {
            color: var(--tool-color);
            margin-right: 0.3rem;
        }
        .tool__args {
            color: var(--text-secondary);
        }
        .tool__body {
            margin-top: 0.1rem;
            padding-left: 0;
            color: var(--text-secondary);
            word-break: break-all;
        }
        .tool__body-line {
            white-space: pre-wrap;
        }
        .tool--success .tool__icon { color: var(--success-color); }
        .tool--error .tool__icon { color: var(--error-color); }

        /* è¾“å…¥åŒº */
        .input-area {
            border-top: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
        }
        .input-wrap { max-width: 800px; margin: 0 auto; }
        .input-form {
            display: flex;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .input-form textarea {
            flex: 1;
            background: none;
            color: var(--text-primary);
            border: none;
            padding: 0.45rem 0.65rem;
            font-size: 0.85rem;
            font-family: var(--font-family);
            outline: none;
            resize: none;
            max-height: 160px;
        }
        .input-form button {
            background: var(--accent-assistant);
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 0 0.8rem;
            margin: 0.3rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            width: min(400px, 90vw);
            background: #0b0b0b;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .modal__header {
            padding: 0.65rem 0.9rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: 0.9rem;
        }
        .modal__body { padding: 0.65rem 0.9rem; }
        .modal__item {
            padding: 0.45rem 0.55rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 0.35rem;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .modal__item:hover { border-color: var(--accent-assistant); background: rgba(255,158,128,0.06); }
        .modal__input {
            width: 100%;
            padding: 0.45rem 0.55rem;
            border: 1px solid var(--border-color);
            background: #0d0d0d;
            color: var(--text-primary);
            border-radius: 5px;
            outline: none;
            font-size: 0.85rem;
        }
        .modal__actions { padding: 0 0.9rem 0.65rem; display: flex; justify-content: flex-end; }
        .modal__btn {
            background: var(--accent-assistant);
            color: #000;
            border: none;
            border-radius: 5px;
            padding: 0.35rem 0.7rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        @media (max-width: 800px) {
            #app-shell { flex-direction: column; }
            .sidebar { width: 100%; height: 220px; border-right: none; border-bottom: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>
    <div id="app-shell">
        <aside class="sidebar">
            <!-- è§†å›¾åˆ‡æ¢æ ‡ç­¾ -->
            <div class="sidebar__tabs">
                <button class="sidebar__tab sidebar__tab--active" data-view="history">å†å²å¯¹è¯</button>
                <button class="sidebar__tab" data-view="chain">å½“å‰å¯¹è¯</button>
                <button class="sidebar__tab" data-view="memory">è®°å¿†</button>
            </div>

            <!-- å†å²å¯¹è¯è§†å›¾ -->
            <div class="sidebar__view sidebar__view--active" id="view-history">
                <div class="history-header">
                    <button class="history-new-btn" id="new-chat-btn">+ æ–°å¯¹è¯</button>
                </div>
                <div class="history-list" id="history-list">
                    <div class="history-empty" id="history-empty">æš‚æ— å†å²å¯¹è¯</div>
                </div>
            </div>

            <!-- å½“å‰å¯¹è¯é“¾è§†å›¾ -->
            <div class="sidebar__view" id="view-chain">
                <div class="chain-header">
                    <div class="chain-header__title">å½“å‰å¯¹è¯</div>
                    <div class="chain-header__hint">ç‚¹å‡»å…‹éš†: ä»æ­¤æ¶ˆæ¯åˆ›å»ºæ–°å¯¹è¯</div>
                </div>
                <div class="chain-list" id="chain-list">
                    <div style="color:var(--text-secondary);font-size:0.8rem;text-align:center;padding:2rem 1rem" id="chain-empty">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>
                </div>
            </div>

            <!-- è®°å¿†ç®¡ç†è§†å›¾ -->
            <div class="sidebar__view" id="view-memory">
                <div class="memory-header">
                    <div class="memory-header__title">è®°å¿†ç®¡ç†</div>
                    <div class="memory-header__actions">
                        <button class="memory-btn" id="memory-search-btn">ğŸ”</button>
                        <button class="memory-btn" id="memory-clean-btn">ğŸ§¹</button>
                    </div>
                </div>
                <div class="memory-stats" id="memory-stats">å…± 0 æ¡è®°å¿†</div>
                <div class="memory-canvas" id="memory-canvas">
                    <div class="memory-empty" id="memory-empty">/memory edit è¿›å…¥ç®¡ç†</div>
                </div>
            </div>
        </aside>

        <main class="main">
            <header class="main__header"><pre id="logo"></pre></header>
            <div class="status-bar" id="status-bar"></div>
            <div class="messages-wrapper" id="messages-wrapper">
                <div class="messages" id="messages"></div>
            </div>
            <div class="input-area">
                <div class="input-wrap">
                    <form class="input-form" id="input-form">
                        <textarea id="input" placeholder="Ask Paw anything..." rows="1"></textarea>
                        <button type="submit">Send</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal">
            <div id="modal-title" class="modal__header">é€‰æ‹©æ¨¡å‹</div>
            <div id="modal-body" class="modal__body"></div>
            <div id="modal-actions" class="modal__actions" style="display:none;">
                <button id="modal-ok" class="modal__btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½® ==========
        const LOGO = `â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•”â•â•â•â•   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•       â•šâ•â•  â•šâ•â•   â•šâ•â•â•â•šâ•â•â• `;

        marked.setOptions({
            highlight: (code, lang) => hljs.getLanguage(lang) ? hljs.highlight(code, { language: lang }).value : hljs.highlightAuto(code).value,
            langPrefix: 'hljs language-', gfm: true, breaks: true
        });

        // ========== DOM ==========
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);
        
        // ç¼“å­˜ä¼šè¯åˆ—è¡¨ï¼Œç”¨äºå‰ç«¯åˆ¤æ–­ï¼ˆéœ€è¦åœ¨ newChatBtn äº‹ä»¶ä¹‹å‰å®šä¹‰ï¼‰
        let cachedSessions = [];
        
        const dom = {
            logo: $('#logo'),
            statusBar: $('#status-bar'),
            msgWrap: $('#messages-wrapper'),
            messages: $('#messages'),
            form: $('#input-form'),
            input: $('#input'),
            modal: $('#modal'),
            modalTitle: $('#modal-title'),
            modalBody: $('#modal-body'),
            modalActions: $('#modal-actions'),
            modalOk: $('#modal-ok'),
            historyList: $('#history-list'),
            historyEmpty: $('#history-empty'),
            newChatBtn: $('#new-chat-btn'),
            viewHistory: $('#view-history'),
            viewChain: $('#view-chain'),
            viewMemory: $('#view-memory'),
            chainList: $('#chain-list'),
            memoryCanvas: $('#memory-canvas'),
            memoryEmpty: $('#memory-empty'),
            memoryStats: $('#memory-stats'),
            memorySearchBtn: $('#memory-search-btn'),
            memoryCleanBtn: $('#memory-clean-btn')
        };
        dom.logo.textContent = LOGO;

        // ========== è§†å›¾åˆ‡æ¢ ==========
        $$('.sidebar__tab').forEach(tab => {
            tab.addEventListener('click', () => {
                $$('.sidebar__tab').forEach(t => t.classList.remove('sidebar__tab--active'));
                tab.classList.add('sidebar__tab--active');
                const view = tab.dataset.view;
                dom.viewHistory.classList.toggle('sidebar__view--active', view === 'history');
                dom.viewChain.classList.toggle('sidebar__view--active', view === 'chain');
                dom.viewMemory.classList.toggle('sidebar__view--active', view === 'memory');
                // åˆ‡æ¢åˆ°å¯¹è¯é“¾è§†å›¾æ—¶åˆ·æ–°
                if (view === 'chain') ChatHistory.renderChain();
            });
        });

        // ========== å†å²å¯¹è¯ç®¡ç† ==========
        const ChatHistory = {
            messages: [],      // å½“å‰å¯¹è¯çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸æŒä¹…åŒ–ï¼‰
            currentSessionId: null,  // å½“å‰ä¼šè¯ID

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(text) {
                const msg = { id: `msg-${Date.now()}`, role: 'user', text };
                this.messages.push(msg);
                dom.messages.appendChild(createMsgEl('user', 'USER', text, msg.id));
                scrollToBottom();
                this.renderChain();
                return msg.id;
            },

            // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
            addAssistantMessage(text) {
                const msg = { id: `msg-${Date.now()}`, role: 'assistant', text };
                this.messages.push(msg);
                this.renderChain();
                return msg.id;
            },

            // æ¸²æŸ“å¯¹è¯é“¾è§†å›¾
            renderChain() {
                if (!this.messages.length) {
                    dom.chainList.innerHTML = '<div style="color:var(--text-secondary);font-size:0.8rem;text-align:center;padding:2rem 1rem">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>';
                    return;
                }
                dom.chainList.innerHTML = '';

                this.messages.forEach((msg, idx) => {
                    const el = document.createElement('div');
                    el.className = 'chain-item';
                    el.innerHTML = `
                        <div class="chain-item__role chain-item__role--${msg.role}">${msg.role === 'user' ? 'USER' : 'PAW'}</div>
                        <div class="chain-item__text">${escapeHtml(msg.text.slice(0, 50))}${msg.text.length > 50 ? 'â€¦' : ''}</div>
                    `;
                    dom.chainList.appendChild(el);
                });
            }
        };

        // å†å²å¯¹è¯äº‹ä»¶ï¼ˆä½¿ç”¨ WebSocket è¯·æ±‚åç«¯ï¼‰
        dom.historyList.addEventListener('click', e => {
            const deleteBtn = e.target.closest('[data-delete]');
            if (deleteBtn) {
                e.stopPropagation();
                ws.send(`/delete-session ${deleteBtn.dataset.delete}`);
                return;
            }
            const item = e.target.closest('.history-item');
            if (item) requestLoadSession(item.dataset.id);
        });

        dom.newChatBtn.addEventListener('click', () => {
            // æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æ˜¯ç©ºå¯¹è¯ï¼ˆmessage_count === 0ï¼‰
            const currentSession = cachedSessions.find(s => s.session_id === ChatHistory.currentSessionId);
            if (currentSession && currentSession.message_count === 0) {
                // å·²ç»åœ¨ç©ºå¯¹è¯ä¸­ï¼Œåªéœ€ç¡®ä¿é«˜äº®å¹¶æ¸…ç©ºèŠå¤©åŒº
                updateSidebarHighlight(ChatHistory.currentSessionId);
                ChatHistory.messages = [];
                dom.messages.innerHTML = '';
                dom.chainList.innerHTML = '<div style="color:var(--text-secondary);font-size:0.8rem;text-align:center;padding:2rem 1rem">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å…¶ä»–ç©ºå¯¹è¯ï¼ˆmessage_count === 0ï¼‰
            const existingEmptySession = cachedSessions.find(s => s.message_count === 0);
            if (existingEmptySession) {
                // åˆ‡æ¢åˆ°å·²å­˜åœ¨çš„ç©ºå¯¹è¯
                requestLoadSession(existingEmptySession.session_id);
                return;
            }
            
            // æ²¡æœ‰ç©ºå¯¹è¯ï¼Œè¯·æ±‚åç«¯åˆ›å»ºæ–°å¯¹è¯
            ws.send('/new');
        });

        // ========== æ¶ˆæ¯æ¸²æŸ“ ==========
        function createMsgEl(type, author, text, id = null) {
            const el = document.createElement('div');
            el.className = `msg msg--${type}`;
            if (id) el.id = id;
            // æ·»åŠ å·¥å…·å®¹å™¨ï¼ˆç”¨äºé™„åŠ è¯¥æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨ï¼‰
            el.innerHTML = `<div class="msg__header">${author}</div><div class="msg__content">${marked.parse(text)}</div><div class="msg__tools"></div>`;
            return el;
        }

        function addSysMsg(text, type = '') {
            const el = document.createElement('div');
            el.className = `sys-msg ${type}`;
            el.textContent = text;
            dom.messages.appendChild(el);
            scrollToBottom();
        }

        function scrollToBottom() { dom.msgWrap.scrollTop = dom.msgWrap.scrollHeight; }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== WebSocket ==========
        const ws = new WebSocket(`ws://${location.host}/ws`);
        ws.onopen = () => {
            addSysMsg('Connected to Paw!');
            // å»¶è¿Ÿè¯·æ±‚ä¼šè¯åˆ—è¡¨ï¼Œç­‰å¾…åç«¯åˆå§‹åŒ–å®Œæˆ
            setTimeout(() => requestSessionList(), 500);
        };
        ws.onclose = () => addSysMsg('Connection closed.', 'error');
        ws.onerror = () => addSysMsg('WebSocket error.', 'error');
        ws.onmessage = e => handleEvent(JSON.parse(e.data));

        function handleEvent({ event, data }) {
            const h = {
                'assistant_stream_start': () => startStream(data.id),
                'assistant_stream_chunk': () => appendStream(data.id, data.text),
                'assistant_stream_end': () => endStream(data.id),
                'tool_start': () => createTool(data),
                'tool_result': () => updateTool(data),
                'system_message': () => addSysMsg(data.text, data.type),
                'status_update': () => updateStatus(data),
                'show_model_selection': () => showModelSelect(data.models),
                'request_input': () => showInputPrompt(data),
                'show_memory': () => Memory.show(data.conversations),
                'memory_result': () => Memory.handleResult(data),
                'session_list': () => handleSessionList(data),
                'session_load': () => handleSessionLoad(data),
                'session_loaded': () => {
                    addSysMsg(`å·²æ¢å¤ä¼šè¯: ${data.title}`, 'system');
                    // æ›´æ–°å½“å‰ä¼šè¯IDå’Œä¾§è¾¹æ é«˜äº®
                    if (data.session_id) {
                        ChatHistory.currentSessionId = data.session_id;
                        updateSidebarHighlight(data.session_id);
                    }
                },
                'new_chat': () => {
                    ChatHistory.messages = [];
                    dom.messages.innerHTML = '';
                    dom.chainList.innerHTML = '<div style="color:var(--text-secondary);font-size:0.8rem;text-align:center;padding:2rem 1rem">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>';
                    // æ›´æ–°å½“å‰ä¼šè¯IDï¼ˆå¦‚æœåç«¯è¿”å›äº†ï¼‰
                    if (data.session_id) {
                        ChatHistory.currentSessionId = data.session_id;
                        // æ›´æ–°ä¾§è¾¹æ é«˜äº®
                        updateSidebarHighlight(data.session_id);
                    }
                    // è¯·æ±‚åˆ·æ–°ä¼šè¯åˆ—è¡¨ä»¥ç¡®ä¿ä¾§è¾¹æ åŒæ­¥
                    requestSessionList();
                }
            };
            h[event]?.();
        }

        // ========== ä¼šè¯ç®¡ç† ==========
        function handleSessionList({ sessions, current_id }) {
            // ç¼“å­˜ä¼šè¯åˆ—è¡¨
            cachedSessions = sessions || [];
            // æ›´æ–°ä¾§è¾¹æ çš„ä¼šè¯åˆ—è¡¨
            dom.historyList.innerHTML = '';
            sessions.forEach(s => {
                const el = document.createElement('div');
                el.className = 'history-item';
                el.dataset.id = s.session_id;
                if (s.session_id === current_id) el.classList.add('history-item--active');
                el.innerHTML = `
                    <div class="history-item__title">${escapeHtml(s.title || 'æ–°å¯¹è¯')}</div>
                    <div class="history-item__meta">${s.timestamp || ''} Â· ${s.message_count || 0} æ¶ˆæ¯</div>
                    <span class="history-item__delete" data-delete="${s.session_id}">Ã—</span>
                `;
                dom.historyList.appendChild(el);
            });
            // æ›´æ–°å½“å‰ä¼šè¯ID
            ChatHistory.currentSessionId = current_id;
        }

        // æ›´æ–°ä¾§è¾¹æ é«˜äº®çŠ¶æ€
        function updateSidebarHighlight(sessionId) {
            dom.historyList.querySelectorAll('.history-item').forEach(item => {
                item.classList.toggle('history-item--active', item.dataset.id === sessionId);
            });
        }

        function handleSessionLoad({ chunks }) {
            // æ¸…ç©ºå½“å‰æ¶ˆæ¯
            ChatHistory.messages = [];
            dom.messages.innerHTML = '';

            // å…ˆæ”¶é›†å·¥å…·ç»“æœï¼ˆç¨åæ›´æ–°ï¼‰
            const toolResults = [];
            // å»ºç«‹ tool_call_id â†’ args çš„æ˜ å°„ï¼ˆç”¨äºé‡æ–°ç”Ÿæˆ displayï¼‰
            const toolArgsMap = new Map();

            // ä» chunks é‡å»ºæ¶ˆæ¯å’Œå·¥å…·è°ƒç”¨
            chunks.forEach(chunk => {
                const type = chunk.type;

                if (type === 'user') {
                    // ç”¨æˆ·æ¶ˆæ¯
                    const msg = { id: `msg-${Date.now()}-${Math.random()}`, role: 'user', text: chunk.content };
                    ChatHistory.messages.push(msg);
                    dom.messages.appendChild(createMsgEl('user', 'USER', chunk.content));

                } else if (type === 'assistant') {
                    // åŠ©æ‰‹æ¶ˆæ¯
                    const msg = { id: `msg-${Date.now()}-${Math.random()}`, role: 'assistant', text: chunk.content || '' };
                    ChatHistory.messages.push(msg);
                    dom.messages.appendChild(createMsgEl('assistant', 'PAW', chunk.content || ''));

                    // å¦‚æœæœ‰ tool_callsï¼Œæ¸²æŸ“å·¥å…·è°ƒç”¨å¹¶ä¿å­˜ args
                    if (chunk.metadata?.tool_calls) {
                        chunk.metadata.tool_calls.forEach(tc => {
                            const func = tc.function || {};
                            const args = func.arguments || '{}';
                            // ä¿å­˜ args åˆ°æ˜ å°„
                            toolArgsMap.set(tc.id, typeof args === 'string' ? JSON.parse(args) : args);
                            createTool({
                                id: tc.id,
                                name: func.name,
                                args: typeof args === 'string' ? args : JSON.stringify(args)
                            });
                        });
                    }

                } else if (type === 'tool_result') {
                    // æ”¶é›†å·¥å…·ç»“æœï¼Œç¨åæ›´æ–°
                    toolResults.push({
                        toolCallId: chunk.metadata?.tool_call_id,
                        toolName: chunk.metadata?.name || 'unknown',
                        content: chunk.content
                    });
                }
            });

            // æ›´æ–°æ‰€æœ‰å·¥å…·ç»“æœçŠ¶æ€
            toolResults.forEach(result => {
                const args = toolArgsMap.get(result.toolCallId) || {};
                const display = getToolDisplay(result.toolName, result.content, args);
                updateTool({
                    id: result.toolCallId,
                    name: result.toolName,
                    display: display,
                    success: true
                });
            });

            scrollToBottom();
            ChatHistory.renderChain();
        }

        // é‡æ–°ç”Ÿæˆå·¥å…·æ˜¾ç¤ºä¿¡æ¯ï¼ˆä¸åç«¯ _get_tool_display é€»è¾‘ä¸€è‡´ï¼‰
        function getToolDisplay(toolName, resultText, args) {
            const content = resultText || '';

            // read_file
            if (toolName === 'read_file') {
                const path = args.file_path || '';
                const filename = path.split('/').pop().split('\\').pop();
                const totalLines = content.split('\n').length;
                const offset = args.offset;
                const limit = args.limit;
                let rangeStr = `(all ${totalLines}è¡Œ)`;
                if (offset && limit) {
                    const end = offset + limit - 1;
                    rangeStr = `(${offset}-${end}/${totalLines}è¡Œ)`;
                } else if (offset) {
                    rangeStr = `(${offset}-end/${totalLines}è¡Œ)`;
                }
                return {
                    line1: `${filename} ${rangeStr}`,
                    line2: '',
                    has_line2: false
                };
            }

            // write_to_file / delete_file / edit / multi_edit
            if (['write_to_file', 'delete_file', 'edit', 'multi_edit'].includes(toolName)) {
                const path = args.file_path || '';
                const filename = path.split('/').pop().split('\\').pop();
                return { line1: filename, line2: '', has_line2: false };
            }

            // list_dir
            if (toolName === 'list_dir') {
                const path = args.directory_path || '.';
                const lines = content.split('\n').filter(l => l.startsWith('['));
                const count = lines.length;
                const preview = lines.slice(0, 3).map(l => {
                    const match = l.match(/\] (.+?)(?: \(|$)/);
                    return match ? match[1] : '';
                }).filter(Boolean).join(', ');
                return {
                    line1: path,
                    line2: preview + (count > 3 ? `... (+${count-3})` : ''),
                    has_line2: count > 0
                };
            }

            // find_by_name
            if (toolName === 'find_by_name') {
                const pattern = args.pattern || '';
                const items = content.split('\n').filter(Boolean);
                const count = items.length;
                if (count === 0) {
                    return { line1: `"${pattern}" æ— åŒ¹é…`, line2: '', has_line2: false };
                }
                const names = items.slice(0, 3).map(i => i.split('/').pop().split('\\').pop());
                const preview = names.join(', ');
                return {
                    line1: `"${pattern}" ${count}åŒ¹é…`,
                    line2: preview + (count > 3 ? `... (+${count-3})` : ''),
                    has_line2: true
                };
            }

            // grep_search
            if (toolName === 'grep_search') {
                const query = args.query || '';
                const resultText = content.trim();
                if (!resultText || resultText.toLowerCase().includes('no matches')) {
                    return { line1: `"${query}" æ— åŒ¹é…`, line2: '', has_line2: false };
                }
                const lines = resultText.split('\n');
                const summary = lines[0]?.slice(0, 60) + (lines[0].length > 60 ? '...' : '');
                return {
                    line1: `"${query}"`,
                    line2: summary + (lines.length > 1 ? ` (+${lines.length-1})` : ''),
                    has_line2: true
                };
            }

            // search_web
            if (toolName === 'search_web') {
                const query = args.query || '';
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const data = JSON.parse(jsonMatch[0]);
                        const results = data.results || [];
                        return {
                            line1: `${results.length}æ¡ "${query}"`,
                            line2: results.map(r => `[${r.id}] ${r.title}`).join('\n'),
                            has_line2: results.length > 0
                        };
                    }
                } catch (e) {}
                return { line1: `"${query}"`, line2: '', has_line2: false };
            }

            // load_url_content
            if (toolName === 'load_url_content') {
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const data = JSON.parse(jsonMatch[0]);
                        const title = (data.title || 'æ— æ ‡é¢˜').slice(0, 40);
                        const urlId = data.url_id || '';
                        const pages = data.pages || [];
                        return {
                            line1: urlId ? `[${urlId}] ${title}` : title,
                            line2: pages.map(p => `[${p.page_id}] ${p.summary}`).join('\n'),
                            has_line2: pages.length > 0
                        };
                    }
                } catch (e) {}
                return { line1: args.url?.slice(0, 40) || '', line2: '', has_line2: false };
            }

            // read_page
            if (toolName === 'read_page') {
                const pageId = args.page_id || '';
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const data = JSON.parse(jsonMatch[0]);
                        const pageNum = data.page_num || '?';
                        const total = data.total_pages || '?';
                        const size = data.size || 0;
                        return {
                            line1: `[${pageId}] ç¬¬${pageNum}/${total}é¡µ (${size}å­—èŠ‚)`,
                            line2: '',
                            has_line2: false
                        };
                    }
                } catch (e) {}
                return { line1: `[${pageId}]`, line2: '', has_line2: false };
            }

            // é»˜è®¤ï¼šå¤šè¡Œå†…å®¹æ˜¾ç¤º
            if (content.includes('\n')) {
                const lines = content.split('\n');
                return {
                    line1: lines[0]?.slice(0, 60) || '',
                    line2: lines.slice(1, 10).join('\n'),
                    has_line2: true
                };
            }

            return { line1: content.slice(0, 60), line2: '', has_line2: false };
        }

        // è¯·æ±‚ä¼šè¯åˆ—è¡¨
        function requestSessionList() {
            ws.send('/sessions');
        }

        // è¯·æ±‚åŠ è½½ä¼šè¯
        function requestLoadSession(sessionId) {
            ws.send(`/load ${sessionId}`);
        }

        function send(msg) {
            if (ws.readyState === WebSocket.OPEN) ws.send(msg);
            else addSysMsg('æœªè¿æ¥', 'error');
        }

        // ========== æ¶ˆæ¯å¤„ç† ==========
        let streamId = null, streamBuf = '';

        function addUserMessage(text) {
            return ChatHistory.addUserMessage(text);
        }

        function startStream(id) {
            streamId = id;
            streamBuf = '';
            dom.messages.appendChild(createMsgEl('assistant', 'PAW', '', id));
        }

        function appendStream(id, text) {
            const content = document.getElementById(id)?.querySelector('.msg__content');
            if (!content) return;
            streamBuf += text;
            content.innerHTML = marked.parse(streamBuf);
            scrollToBottom();
        }

        function endStream(id) {
            const content = document.getElementById(id)?.querySelector('.msg__content');
            if (content) {
                content.querySelectorAll('pre code').forEach(el => {
                    const pre = el.parentElement;
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.textContent = 'Copy';
                    btn.onclick = () => { navigator.clipboard.writeText(el.textContent); btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 2000); };
                    pre.appendChild(btn);
                });
            }

            // ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯åˆ°å¯¹è¯å†å²
            ChatHistory.addAssistantMessage(streamBuf);

            streamId = null;
            streamBuf = '';
        }

        function createTool({ id, name, args }) {
            const el = document.createElement('div');
            el.id = `tool-${id}`;
            el.className = 'tool';
            // Shell é£æ ¼ï¼šâ—‹ tool_name args
            el.innerHTML = `<div class="tool__header"><div class="tool__spinner"></div><span class="tool__name">${name}</span> <span class="tool__args">${args}</span></div>`;

            // é™„åŠ åˆ°ä¸Šä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯çš„å·¥å…·å®¹å™¨ä¸­
            const toolsContainer = dom.messages.querySelector('.msg--assistant:last-child .msg__tools');
            if (toolsContainer) {
                toolsContainer.appendChild(el);
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°åŠ©æ‰‹æ¶ˆæ¯ï¼ˆè¾¹ç¼˜æƒ…å†µï¼‰ï¼Œæš‚æ—¶ç›´æ¥æ·»åŠ 
                dom.messages.appendChild(el);
            }
            scrollToBottom();
        }

        function updateTool({ id, name, display, success }) {
            const el = document.getElementById(`tool-${id}`);
            if (!el) return;
            el.className = `tool ${success ? 'tool--success' : 'tool--error'}`;

            const line1 = display.line1 || '';
            const line2 = display.line2 || '';
            const hasLine2 = display.has_line2 || false;

            // Header: â— tool_name line1
            let headerHtml = `<span class="tool__icon">â—</span><span class="tool__name">${name}</span> <span class="tool__args">${line1}</span>`;

            // Body: æ¯è¡Œå‰é¢åŠ  â¿
            let bodyHtml = '';
            if (hasLine2 && line2) {
                const lines = line2.split('\n');
                let firstLine = true;
                lines.forEach(line => {
                    // å¦‚æœè¡Œä»¥ â”‚ å¼€å¤´ï¼ˆè¿æ¥çº¿ï¼‰ï¼Œä¿ç•™åŸæ ·
                    if (line.startsWith('â”‚')) {
                        bodyHtml += `<div class="tool__body-line">${escapeHtml(line)}</div>`;
                    } else {
                        // ç¬¬ä¸€è¡Œç”¨ â¿ï¼Œåç»­è¡Œç”¨ç©ºæ ¼å¯¹é½
                        const prefix = firstLine ? 'â¿ ' : '  ';
                        bodyHtml += `<div class="tool__body-line">${prefix}${escapeHtml(line)}</div>`;
                        firstLine = false;
                    }
                });
            }

            el.innerHTML = `<div class="tool__header">${headerHtml}</div>${bodyHtml ? `<div class="tool__body">${bodyHtml}</div>` : ''}`;
        }

        function updateStatus(data) {
            const parts = [];
            if (data.time) parts.push(`time: ${data.time}`);
            if (data.model) parts.push(`model: ${data.model}`);
            if (data.mode) parts.push(`mode: ${data.mode}`);
            dom.statusBar.textContent = parts.join(' Â· ');
        }

        function scrollToBottom() { dom.msgWrap.scrollTop = dom.msgWrap.scrollHeight; }

        // ========== å¼¹çª— ==========
        function showModelSelect(models) {
            dom.modalTitle.textContent = 'é€‰æ‹©æ¨¡å‹';
            dom.modalBody.innerHTML = models.map(m => `<div class="modal__item" data-model="${m}">${m}</div>`).join('');
            dom.modalActions.style.display = 'none';
            dom.modal.classList.add('visible');
        }

        function showInputPrompt(data) {
            dom.modalTitle.textContent = data?.prompt || 'è¾“å…¥';
            dom.modalBody.innerHTML = '<input type="text" class="modal__input" placeholder="è¾“å…¥...">';
            dom.modalActions.style.display = 'flex';
            dom.modal.classList.add('visible');
            setTimeout(() => dom.modalBody.querySelector('input')?.focus(), 30);
        }

        dom.modalBody.addEventListener('click', e => {
            const item = e.target.closest('.modal__item');
            if (item) { send(item.dataset.model); dom.modal.classList.remove('visible'); }
        });

        dom.modalOk.addEventListener('click', () => {
            const v = dom.modalBody.querySelector('input')?.value.trim();
            if (v) { send(v); dom.modal.classList.remove('visible'); }
        });

        // ========== è¾“å…¥ ==========
        function handleSubmit() {
            const msg = dom.input.value.trim();
            if (!msg) return;
            send(msg);
            addUserMessage(msg);
            dom.input.value = '';
            autoResize();
        }

        function autoResize() {
            dom.input.style.height = 'auto';
            dom.input.style.height = dom.input.scrollHeight + 'px';
        }

        dom.form.addEventListener('submit', e => { e.preventDefault(); handleSubmit(); });
        dom.input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(); } });
        dom.input.addEventListener('input', autoResize);

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== è®°å¿†ç®¡ç† ==========
        const Memory = {
            conversations: [],
            selectedIndex: 0,
            active: false,

            show(conversations) {
                this.conversations = conversations || [];
                this.selectedIndex = 0;
                this.active = true;
                this.render();
                // è‡ªåŠ¨åˆ‡æ¢åˆ°è®°å¿†è§†å›¾
                $$('.sidebar__tab').forEach(t => {
                    t.classList.toggle('sidebar__tab--active', t.dataset.view === 'memory');
                });
                $$('.sidebar__view').forEach(v => v.classList.remove('sidebar__view--active'));
                dom.viewMemory.classList.add('sidebar__view--active');
            },

            hide() {
                this.active = false;
                dom.memoryCanvas.innerHTML = '<div class="memory-empty">/memory æ‰“å¼€è®°å¿†ç®¡ç†</div>';
            },

            render() {
                const count = this.conversations.length;
                dom.memoryStats.textContent = `å…± ${count} æ¡è®°å¿†`;

                if (!count) {
                    dom.memoryCanvas.innerHTML = '<div class="memory-empty">æš‚æ— è®°å¿†</div>';
                    return;
                }

                let html = '';
                this.conversations.forEach((conv, idx) => {
                    const meta = conv.metadata || {};
                    const userMsg = meta.user_message || '';
                    const preview = userMsg.substring(0, 40);
                    const timestamp = meta.timestamp || '';
                    const isActive = idx === this.selectedIndex;
                    html += `
                        <div class="memory-item ${isActive ? 'memory-item--active' : ''}" data-index="${idx}" data-id="${conv.id}">
                            <div class="memory-item__msg">${escapeHtml(preview)}</div>
                            <div class="memory-item__meta">${timestamp.substring(0, 16)}</div>
                            <button class="memory-item__delete" data-delete="${conv.id}">Ã—</button>
                        </div>
                    `;
                });

                dom.memoryCanvas.innerHTML = html;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                dom.memoryCanvas.querySelectorAll('.memory-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.classList.contains('memory-item__delete')) return;
                        const idx = parseInt(e.currentTarget.dataset.index);
                        this.select(idx);
                    });
                });

                // ç»‘å®šåˆ é™¤äº‹ä»¶
                dom.memoryCanvas.querySelectorAll('.memory-item__delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.target.dataset.delete;
                        if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ')) {
                            send(`MEMORY_DELETE:${id}`);
                        }
                    });
                });
            },

            select(idx) {
                this.selectedIndex = idx;
                this.render();

                // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
                const conv = this.conversations[idx];
                if (conv) {
                    this.showDetail(conv);
                }
            },

            showDetail(conv) {
                const meta = conv.metadata || {};
                dom.modalTitle.textContent = 'è®°å¿†è¯¦æƒ…';
                dom.modalBody.innerHTML = `
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem">
                        ID: ${conv.id}<br>
                        é¡¹ç›®: ${meta.project || '(æ— )'}<br>
                        æ—¶é—´: ${meta.timestamp || '(æœªçŸ¥)'}
                    </div>
                    <div style="margin-bottom:0.5rem;color:var(--accent-user)">ç”¨æˆ·:</div>
                    <div style="background:#0d0d0d;padding:0.5rem;border-radius:4px;margin-bottom:0.5rem;max-height:120px;overflow:auto">${escapeHtml(meta.user_message || '(æ— )')}</div>
                    <div style="margin-bottom:0.5rem;color:var(--accent-assistant)">AI:</div>
                    <div style="background:#0d0d0d;padding:0.5rem;border-radius:4px;max-height:120px;overflow:auto">${escapeHtml(meta.assistant_message || '(æ— )')}</div>
                `;
                dom.modalActions.style.display = 'none';
                dom.modal.classList.add('visible');
            },

            search(keyword) {
                send(`MEMORY_SEARCH:${keyword}`);
            },

            clean() {
                if (confirm('ç¡®å®šæ¸…ç†é‡å¤çš„è®°å¿†å—ï¼Ÿ')) {
                    send('MEMORY_CLEAN');
                }
            },

            handleResult(data) {
                if (data.success) {
                    addSysMsg(data.message || 'æ“ä½œæˆåŠŸ');
                    if (data.conversations) {
                        this.conversations = data.conversations;
                        this.render();
                    }
                    // ä¸éšè—è®°å¿†ç®¡ç†ï¼Œç»§ç»­ç¼–è¾‘æ¨¡å¼
                } else {
                    addSysMsg(data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            }
        };

        // è®°å¿†ç®¡ç†å¿«æ·é”®
        dom.input.addEventListener('keydown', e => {
            if (!Memory.active) return;
            if (e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'ArrowUp' || e.key === 'k') {
                e.preventDefault();
                Memory.select(Math.max(0, Memory.selectedIndex - 1));
            } else if (e.key === 'ArrowDown' || e.key === 'j') {
                e.preventDefault();
                Memory.select(Math.min(Memory.conversations.length - 1, Memory.selectedIndex + 1));
            } else if (e.key === 'q' || e.key === 'Q' || e.key === 'Escape') {
                e.preventDefault();
                Memory.hide();
            }
        });

        // è®°å¿†æŒ‰é’®äº‹ä»¶
        dom.memorySearchBtn.addEventListener('click', () => {
            const keyword = prompt('è¾“å…¥æœç´¢å…³é”®è¯:');
            if (keyword) Memory.search(keyword);
        });

        dom.memoryCleanBtn.addEventListener('click', () => {
            Memory.clean();
        });

        // ========== å¯åŠ¨ ==========
        addSysMsg('Waiting for Paw...');
        autoResize();
    </script>
</body>
</html>
