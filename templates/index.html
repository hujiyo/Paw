<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paw</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.css">
    <style>
        :root {
            --font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            --bg-color: #000000;
            --bg-secondary: #0a0a0a;
            --text-primary: #EAEAEA;
            --text-secondary: #666666;
            --border-color: #333333;
            --accent-user: #80D1FF;
            --accent-assistant: #FF9E80;
            --accent-active: #50FA7B;
            --tool-color: #00FFFF;
            --error-color: #FF5555;
            --success-color: #50FA7B;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background: var(--bg-color); color: var(--text-primary); }
        #app-shell { display: flex; height: 100vh; }

        /* ===== ä¾§è¾¹æ  ===== */
        .sidebar {
            width: 280px;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }

        /* è§†å›¾åˆ‡æ¢æ ‡ç­¾ */
        .sidebar__tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar__tab {
            flex: 1;
            padding: 0.7rem 0.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .sidebar__tab:hover { color: var(--text-primary); }
        .sidebar__tab--active {
            color: var(--accent-assistant);
            border-bottom-color: var(--accent-assistant);
        }

        /* è§†å›¾å®¹å™¨ */
        .sidebar__view {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar__view--active { display: flex; }

        /* === å†å²å¯¹è¯è§†å›¾ === */
        .history-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .history-new-btn {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255,158,128,0.1);
            border: 1px dashed rgba(255,158,128,0.4);
            border-radius: 6px;
            color: var(--accent-assistant);
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .history-new-btn:hover { background: rgba(255,158,128,0.2); }
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .history-item {
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.35rem;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }
        .history-item:hover { background: rgba(255,255,255,0.05); }
        .history-item--active { background: rgba(255,158,128,0.12); }
        .history-item__title {
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.2rem;
        }
        .history-item__meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .history-item__delete {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            font-size: 0.9rem;
            padding: 0.2rem;
        }
        .history-item:hover .history-item__delete { opacity: 1; }
        .history-item__delete:hover { color: var(--error-color); }
        .history-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
            padding: 2rem 1rem;
        }

        /* === å¯¹è¯æ ‘è§†å›¾ === */
        .tree-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .tree-header__title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }
        .tree-header__hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .tree-canvas {
            flex: 1;
            overflow: auto;
            padding: 1rem;
        }
        .tree-svg { display: block; }
        .tree-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
            padding: 2rem 1rem;
        }
        .tree-node {
            cursor: pointer;
        }
        .tree-node:hover {
            filter: brightness(1.3);
        }
        .tree-node--user { fill: var(--accent-user); }
        .tree-node--assistant { fill: var(--accent-assistant); }
        .tree-node--active {
            stroke: var(--accent-active);
            stroke-width: 2;
            filter: drop-shadow(0 0 4px var(--accent-active));
        }
        .tree-edge {
            stroke: var(--border-color);
            stroke-width: 1.5;
            fill: none;
        }

        /* æ‚¬æµ®æç¤º */
        .tooltip {
            position: fixed;
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            max-width: 260px;
            font-size: 0.75rem;
            line-height: 1.4;
            pointer-events: none;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .tooltip.visible { display: block; }
        .tooltip__role {
            font-size: 0.65rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .tooltip__role--user { color: var(--accent-user); }
        .tooltip__role--assistant { color: var(--accent-assistant); }
        .tooltip__text { color: var(--text-secondary); word-break: break-word; }

        /* å³é”®èœå• */
        .ctx-menu {
            position: fixed;
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.25rem 0;
            min-width: 130px;
            z-index: 1001;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .ctx-menu.visible { display: block; }
        .ctx-menu__item {
            padding: 0.45rem 0.7rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        .ctx-menu__item:hover { background: rgba(255,255,255,0.08); }
        .ctx-menu__item--danger { color: var(--error-color); }

        /* ===== è®°å¿†ç®¡ç† ===== */
        .memory-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .memory-header__title {
            font-size: 0.85rem;
            font-weight: 600;
        }
        .memory-header__actions {
            display: flex;
            gap: 0.4rem;
        }
        .memory-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 4px;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .memory-btn:hover {
            border-color: var(--accent-assistant);
            color: var(--accent-assistant);
        }
        .memory-stats {
            padding: 0.4rem 0.75rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .memory-canvas {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .memory-empty {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: center;
            padding: 2rem 1rem;
        }
        .memory-item {
            padding: 0.5rem 0.6rem;
            border-radius: 5px;
            margin-bottom: 0.3rem;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.75rem;
            position: relative;
        }
        .memory-item:hover { background: rgba(255,255,255,0.05); }
        .memory-item--active { background: rgba(255,158,128,0.15); }
        .memory-item__msg {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.2rem;
        }
        .memory-item--active .memory-item__msg { color: var(--text-primary); }
        .memory-item__meta {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        .memory-item__delete {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0;
            font-size: 0.9rem;
            padding: 0.2rem;
        }
        .memory-item:hover .memory-item__delete { opacity: 1; }
        .memory-item__delete:hover { color: var(--error-color); }
        .memory-item__checkbox {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ===== ä¸»å†…å®¹åŒº ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .main__header {
            padding: 1rem 0 0.5rem;
            text-align: center;
        }
        #logo {
            font-family: var(--font-family);
            font-size: 12px;
            line-height: 1.15;
            color: var(--accent-assistant);
            white-space: pre;
            text-shadow: 0 0 5px rgba(255, 158, 128, 0.5);
            margin: 0;
        }
        .status-bar {
            color: var(--text-secondary);
            text-align: center;
            padding: 0.4rem;
            font-size: 0.75rem;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .messages {
            max-width: 800px;
            margin: 0 auto;
            padding: 1.25rem 1rem;
        }

        /* æ¶ˆæ¯ */
        .msg { margin-bottom: 1.25rem; }
        .msg__header {
            display: inline-block;
            font-weight: bold;
            padding: 0.15rem 0.5rem;
            margin-bottom: 0.35rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .msg--user .msg__header { background: var(--accent-user); color: #000; }
        .msg--assistant .msg__header { background: var(--accent-assistant); color: #000; }
        .msg__content { line-height: 1.65; padding-left: 0.4rem; }
        .msg__content pre {
            position: relative;
            background: #1a1a1a;
            padding: 0.65rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.8em;
            overflow-x: auto;
        }
        .msg__content code:not(pre > code) {
            background: rgba(255,158,128,0.1);
            color: var(--accent-assistant);
            padding: 0.1em 0.25em;
            border-radius: 3px;
        }
        .copy-btn {
            position: absolute;
            top: 0.35rem;
            right: 0.35rem;
            background: var(--border-color);
            color: var(--text-primary);
            border: none;
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0;
            font-size: 0.65rem;
        }
        .msg__content pre:hover .copy-btn { opacity: 1; }
        .sys-msg {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            padding: 0.25rem 0;
        }
        .sys-msg.error { color: var(--error-color); }

        /* å·¥å…·è°ƒç”¨ - Shell é£æ ¼ */
        .tool {
            margin: 0.5rem 0;
            font-size: 0.8rem;
            font-family: var(--font-family);
            line-height: 1.5;
        }
        .tool__header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .tool__spinner {
            width: 0.8em;
            height: 0.8em;
            border: 2px solid var(--tool-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.4rem;
            flex-shrink: 0;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tool__icon {
            margin-right: 0.4rem;
            min-width: 0.8em;
            flex-shrink: 0;
        }
        .tool__name {
            color: var(--tool-color);
            margin-right: 0.3rem;
        }
        .tool__args {
            color: var(--text-secondary);
        }
        .tool__body {
            margin-top: 0.1rem;
            padding-left: 0;
            color: var(--text-secondary);
            word-break: break-all;
        }
        .tool__body-line {
            white-space: pre-wrap;
        }
        .tool--success .tool__icon { color: var(--success-color); }
        .tool--error .tool__icon { color: var(--error-color); }

        /* è¾“å…¥åŒº */
        .input-area {
            border-top: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
        }
        .input-wrap { max-width: 800px; margin: 0 auto; }
        .input-form {
            display: flex;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .input-form textarea {
            flex: 1;
            background: none;
            color: var(--text-primary);
            border: none;
            padding: 0.45rem 0.65rem;
            font-size: 0.85rem;
            font-family: var(--font-family);
            outline: none;
            resize: none;
            max-height: 160px;
        }
        .input-form button {
            background: var(--accent-assistant);
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 0 0.8rem;
            margin: 0.3rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            width: min(400px, 90vw);
            background: #0b0b0b;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .modal__header {
            padding: 0.65rem 0.9rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: 0.9rem;
        }
        .modal__body { padding: 0.65rem 0.9rem; }
        .modal__item {
            padding: 0.45rem 0.55rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 0.35rem;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .modal__item:hover { border-color: var(--accent-assistant); background: rgba(255,158,128,0.06); }
        .modal__input {
            width: 100%;
            padding: 0.45rem 0.55rem;
            border: 1px solid var(--border-color);
            background: #0d0d0d;
            color: var(--text-primary);
            border-radius: 5px;
            outline: none;
            font-size: 0.85rem;
        }
        .modal__actions { padding: 0 0.9rem 0.65rem; display: flex; justify-content: flex-end; }
        .modal__btn {
            background: var(--accent-assistant);
            color: #000;
            border: none;
            border-radius: 5px;
            padding: 0.35rem 0.7rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        @media (max-width: 800px) {
            #app-shell { flex-direction: column; }
            .sidebar { width: 100%; height: 220px; border-right: none; border-bottom: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>
    <div id="app-shell">
        <aside class="sidebar">
            <!-- è§†å›¾åˆ‡æ¢æ ‡ç­¾ -->
            <div class="sidebar__tabs">
                <button class="sidebar__tab sidebar__tab--active" data-view="history">å†å²å¯¹è¯</button>
                <button class="sidebar__tab" data-view="tree">å¯¹è¯æ ‘</button>
                <button class="sidebar__tab" data-view="memory">è®°å¿†</button>
            </div>

            <!-- å†å²å¯¹è¯è§†å›¾ -->
            <div class="sidebar__view sidebar__view--active" id="view-history">
                <div class="history-header">
                    <button class="history-new-btn" id="new-chat-btn">+ æ–°å¯¹è¯</button>
                </div>
                <div class="history-list" id="history-list">
                    <div class="history-empty" id="history-empty">æš‚æ— å†å²å¯¹è¯</div>
                </div>
            </div>

            <!-- å¯¹è¯æ ‘è§†å›¾ -->
            <div class="sidebar__view" id="view-tree">
                <div class="tree-header">
                    <div class="tree-header__title">å½“å‰å¯¹è¯ç»“æ„</div>
                    <div class="tree-header__hint">å³é”®: å›é€€/åˆ†å‰/ç¼–è¾‘/åˆ é™¤</div>
                </div>
                <div class="tree-canvas" id="tree-canvas">
                    <div class="tree-empty" id="tree-empty">å‘é€æ¶ˆæ¯å¼€å§‹å¯¹è¯</div>
                    <svg class="tree-svg" id="tree-svg"></svg>
                </div>
            </div>

            <!-- è®°å¿†ç®¡ç†è§†å›¾ -->
            <div class="sidebar__view" id="view-memory">
                <div class="memory-header">
                    <div class="memory-header__title">è®°å¿†ç®¡ç†</div>
                    <div class="memory-header__actions">
                        <button class="memory-btn" id="memory-search-btn">ğŸ”</button>
                        <button class="memory-btn" id="memory-clean-btn">ğŸ§¹</button>
                    </div>
                </div>
                <div class="memory-stats" id="memory-stats">å…± 0 æ¡è®°å¿†</div>
                <div class="memory-canvas" id="memory-canvas">
                    <div class="memory-empty" id="memory-empty">/memory edit è¿›å…¥ç®¡ç†</div>
                </div>
            </div>
        </aside>

        <main class="main">
            <header class="main__header"><pre id="logo"></pre></header>
            <div class="status-bar" id="status-bar"></div>
            <div class="messages-wrapper" id="messages-wrapper">
                <div class="messages" id="messages"></div>
            </div>
            <div class="input-area">
                <div class="input-wrap">
                    <form class="input-form" id="input-form">
                        <textarea id="input" placeholder="Ask Paw anything..." rows="1"></textarea>
                        <button type="submit">Send</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div class="tooltip" id="tooltip"></div>
    <div class="ctx-menu" id="ctx-menu">
        <div class="ctx-menu__item" data-action="fork">â†» ä»æ­¤å¤„é‡æ–°è¾“å…¥</div>
        <div class="ctx-menu__item" data-action="edit">âœ ç¼–è¾‘æ¶ˆæ¯</div>
        <div class="ctx-menu__item ctx-menu__item--danger" data-action="delete">âœ• åˆ é™¤æ­¤æ¡åŠä¹‹å</div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal">
            <div id="modal-title" class="modal__header">é€‰æ‹©æ¨¡å‹</div>
            <div id="modal-body" class="modal__body"></div>
            <div id="modal-actions" class="modal__actions" style="display:none;">
                <button id="modal-ok" class="modal__btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // ========== é…ç½® ==========
        const LOGO = `â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•”â•â•â•â•   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•
â•šâ•â•       â•šâ•â•  â•šâ•â•   â•šâ•â•â•â•šâ•â•â• `;

        const NODE_RADIUS = 6;
        const LEVEL_HEIGHT = 40;
        const SIBLING_GAP = 30;

        marked.setOptions({
            highlight: (code, lang) => hljs.getLanguage(lang) ? hljs.highlight(code, { language: lang }).value : hljs.highlightAuto(code).value,
            langPrefix: 'hljs language-', gfm: true, breaks: true
        });

        // ========== DOM ==========
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);
        const dom = {
            logo: $('#logo'),
            statusBar: $('#status-bar'),
            msgWrap: $('#messages-wrapper'),
            messages: $('#messages'),
            form: $('#input-form'),
            input: $('#input'),
            treeSvg: $('#tree-svg'),
            treeEmpty: $('#tree-empty'),
            tooltip: $('#tooltip'),
            ctxMenu: $('#ctx-menu'),
            modal: $('#modal'),
            modalTitle: $('#modal-title'),
            modalBody: $('#modal-body'),
            modalActions: $('#modal-actions'),
            modalOk: $('#modal-ok'),
            historyList: $('#history-list'),
            historyEmpty: $('#history-empty'),
            newChatBtn: $('#new-chat-btn'),
            viewHistory: $('#view-history'),
            viewTree: $('#view-tree'),
            viewMemory: $('#view-memory'),
            memoryCanvas: $('#memory-canvas'),
            memoryEmpty: $('#memory-empty'),
            memoryStats: $('#memory-stats'),
            memorySearchBtn: $('#memory-search-btn'),
            memoryCleanBtn: $('#memory-clean-btn')
        };
        dom.logo.textContent = LOGO;

        // ========== è§†å›¾åˆ‡æ¢ ==========
        $$('.sidebar__tab').forEach(tab => {
            tab.addEventListener('click', () => {
                $$('.sidebar__tab').forEach(t => t.classList.remove('sidebar__tab--active'));
                tab.classList.add('sidebar__tab--active');
                const view = tab.dataset.view;
                dom.viewHistory.classList.toggle('sidebar__view--active', view === 'history');
                dom.viewTree.classList.toggle('sidebar__view--active', view === 'tree');
                dom.viewMemory.classList.toggle('sidebar__view--active', view === 'memory');
            });
        });

        // ========== å†å²å¯¹è¯ç®¡ç† ==========
        const ChatHistory = {
            chats: [],          // { id, title, createdAt, tree: { nodes, activeId } }
            currentId: null,

            init() {
                const saved = localStorage.getItem('paw_chats');
                if (saved) {
                    try {
                        this.chats = JSON.parse(saved);
                    } catch (e) { this.chats = []; }
                }
                if (!this.chats.length) this.createNew();
                else this.load(this.chats[0].id);
                this.render();
            },

            save() {
                // ä¿å­˜å½“å‰å¯¹è¯æ ‘åˆ°å½“å‰ chat
                const chat = this.chats.find(c => c.id === this.currentId);
                if (chat) {
                    chat.tree = { nodes: Tree.nodes, activeId: Tree.activeId };
                    // æ›´æ–°æ ‡é¢˜ä¸ºç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
                    const firstUser = Tree.nodes.find(n => n.role === 'user');
                    if (firstUser) chat.title = firstUser.text.slice(0, 30) + (firstUser.text.length > 30 ? 'â€¦' : '');
                }
                localStorage.setItem('paw_chats', JSON.stringify(this.chats));
                this.render();
            },

            createNew() {
                const id = `chat-${Date.now()}`;
                const chat = {
                    id,
                    title: 'æ–°å¯¹è¯',
                    createdAt: new Date().toLocaleString('zh-CN'),
                    tree: { nodes: [], activeId: null }
                };
                this.chats.unshift(chat);
                this.load(id);
                this.save();
            },

            load(id) {
                const chat = this.chats.find(c => c.id === id);
                if (!chat) return;
                this.currentId = id;
                Tree.nodes = chat.tree.nodes || [];
                Tree.activeId = chat.tree.activeId;
                TreeUI.render();
                renderMessagesFromTree();
                this.render();
            },

            delete(id) {
                this.chats = this.chats.filter(c => c.id !== id);
                if (this.currentId === id) {
                    if (this.chats.length) this.load(this.chats[0].id);
                    else this.createNew();
                }
                this.save();
            },

            render() {
                if (!this.chats.length) {
                    dom.historyEmpty.style.display = 'block';
                    dom.historyList.querySelectorAll('.history-item').forEach(el => el.remove());
                    return;
                }
                dom.historyEmpty.style.display = 'none';
                
                // æ¸…é™¤æ—§çš„é¡¹ç›®
                dom.historyList.querySelectorAll('.history-item').forEach(el => el.remove());
                
                this.chats.forEach(chat => {
                    const el = document.createElement('div');
                    el.className = `history-item ${chat.id === this.currentId ? 'history-item--active' : ''}`;
                    el.dataset.id = chat.id;
                    el.innerHTML = `
                        <div class="history-item__title">${escapeHtml(chat.title)}</div>
                        <div class="history-item__meta">${chat.createdAt}</div>
                        <button class="history-item__delete" data-delete="${chat.id}">Ã—</button>
                    `;
                    dom.historyList.appendChild(el);
                });
            }
        };

        // å†å²å¯¹è¯äº‹ä»¶
        dom.historyList.addEventListener('click', e => {
            const deleteBtn = e.target.closest('[data-delete]');
            if (deleteBtn) {
                e.stopPropagation();
                ChatHistory.delete(deleteBtn.dataset.delete);
                return;
            }
            const item = e.target.closest('.history-item');
            if (item) ChatHistory.load(item.dataset.id);
        });

        dom.newChatBtn.addEventListener('click', () => ChatHistory.createNew());

        // ========== å¯¹è¯æ ‘æ•°æ®ç»“æ„ ==========
        const Tree = {
            nodes: [],
            activeId: null,

            createNode(role, text, parentId = null) {
                const id = `n${Date.now()}-${Math.random().toString(36).slice(2,5)}`;
                const node = { id, role, text, parentId, children: [] };
                this.nodes.push(node);
                if (parentId) {
                    const parent = this.getNode(parentId);
                    if (parent && !parent.children.includes(id)) parent.children.push(id);
                }
                this.activeId = id;
                ChatHistory.save();
                return node;
            },

            getNode(id) {
                return this.nodes.find(n => n.id === id);
            },

            getPathTo(nodeId) {
                const path = [];
                let cur = this.getNode(nodeId);
                while (cur) {
                    path.unshift(cur);
                    cur = cur.parentId ? this.getNode(cur.parentId) : null;
                }
                return path;
            },

            // æ»šåŠ¨åˆ°æŸèŠ‚ç‚¹å¯¹åº”çš„æ¶ˆæ¯ï¼ˆä¸æ”¹å˜å¯¹è¯çŠ¶æ€ï¼‰
            scrollToNode(nodeId) {
                const msgEl = document.getElementById(nodeId);
                if (msgEl) {
                    msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // çŸ­æš‚é«˜äº®æç¤º
                    msgEl.style.outline = '2px solid var(--accent-active)';
                    setTimeout(() => msgEl.style.outline = '', 1000);
                }
            },

            // ä»æŸä¸ª user èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¤„åˆ†å‰ï¼ˆå‡†å¤‡é‡æ–°è¾“å…¥ï¼‰
            forkFrom(nodeId) {
                const node = this.getNode(nodeId);
                if (!node || node.role !== 'user') return;
                // è®¾ç½® activeId ä¸ºè¯¥ user èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼ˆå³ä¸Šä¸€ä¸ª assistant èŠ‚ç‚¹æˆ– nullï¼‰
                // è¿™æ ·ä¸‹ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¼šæˆä¸ºè¯¥çˆ¶èŠ‚ç‚¹çš„æ–°å­èŠ‚ç‚¹ï¼Œå½¢æˆåˆ†å‰
                this.activeId = node.parentId;
                TreeUI.render();
                renderMessagesFromTree();
                ChatHistory.save();
                // èšç„¦è¾“å…¥æ¡†ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
                dom.input.focus();
            }
        };

        // ========== æ ‘å½¢å¸ƒå±€ ==========
        function layoutTree() {
            if (!Tree.nodes.length) return { positions: {}, width: 0, height: 0 };
            const positions = {};
            const roots = Tree.nodes.filter(n => !n.parentId);
            let nextX = 0;

            function layout(nodeId, depth) {
                const node = Tree.getNode(nodeId);
                if (!node) return;
                if (!node.children.length) {
                    positions[nodeId] = { x: nextX * SIBLING_GAP + 20, y: depth * LEVEL_HEIGHT + 20 };
                    nextX++;
                } else {
                    const childPos = node.children.map(cid => { layout(cid, depth + 1); return positions[cid]; }).filter(Boolean);
                    const minX = Math.min(...childPos.map(p => p.x));
                    const maxX = Math.max(...childPos.map(p => p.x));
                    positions[nodeId] = { x: (minX + maxX) / 2, y: depth * LEVEL_HEIGHT + 20 };
                }
            }

            roots.forEach(root => layout(root.id, 0));
            const allPos = Object.values(positions);
            return {
                positions,
                width: allPos.length ? Math.max(...allPos.map(p => p.x)) + 40 : 0,
                height: allPos.length ? Math.max(...allPos.map(p => p.y)) + 40 : 0
            };
        }

        // ========== æ ‘ UI ==========
        const TreeUI = {
            render() {
                if (!Tree.nodes.length) {
                    dom.treeEmpty.style.display = 'block';
                    dom.treeSvg.innerHTML = '';
                    return;
                }
                dom.treeEmpty.style.display = 'none';
                const { positions, width, height } = layoutTree();
                dom.treeSvg.setAttribute('width', width);
                dom.treeSvg.setAttribute('height', height);
                const activePath = new Set(Tree.getPathTo(Tree.activeId).map(n => n.id));

                let svg = '';
                Tree.nodes.forEach(node => {
                    if (node.parentId && positions[node.id] && positions[node.parentId]) {
                        const p1 = positions[node.parentId], p2 = positions[node.id];
                        svg += `<path class="tree-edge" d="M${p1.x},${p1.y} C${p1.x},${(p1.y+p2.y)/2} ${p2.x},${(p1.y+p2.y)/2} ${p2.x},${p2.y}"/>`;
                    }
                });
                Tree.nodes.forEach(node => {
                    const pos = positions[node.id];
                    if (!pos) return;
                    const cls = `tree-node tree-node--${node.role} ${activePath.has(node.id) ? 'tree-node--active' : ''}`;
                    svg += `<circle class="${cls}" cx="${pos.x}" cy="${pos.y}" r="${NODE_RADIUS}" data-id="${node.id}"/>`;
                });
                dom.treeSvg.innerHTML = svg;
            }
        };

        // ========== Tooltip ==========
        dom.treeSvg.addEventListener('mouseover', e => {
            const circle = e.target.closest('.tree-node');
            if (!circle) return;
            const node = Tree.getNode(circle.dataset.id);
            if (!node) return;
            const preview = node.text.length > 180 ? node.text.slice(0, 180) + 'â€¦' : node.text;
            dom.tooltip.innerHTML = `
                <div class="tooltip__role tooltip__role--${node.role}">${node.role === 'user' ? 'USER' : 'PAW'}</div>
                <div class="tooltip__text">${escapeHtml(preview)}</div>
            `;
            dom.tooltip.classList.add('visible');
            positionTooltip(e);
        });
        dom.treeSvg.addEventListener('mousemove', e => { if (dom.tooltip.classList.contains('visible')) positionTooltip(e); });
        dom.treeSvg.addEventListener('mouseout', e => { if (e.target.closest('.tree-node')) dom.tooltip.classList.remove('visible'); });

        // ç‚¹å‡»èŠ‚ç‚¹ â†’ æ»šåŠ¨åˆ°å¯¹åº”æ¶ˆæ¯
        dom.treeSvg.addEventListener('click', e => {
            const circle = e.target.closest('.tree-node');
            if (!circle) return;
            Tree.scrollToNode(circle.dataset.id);
        });

        function positionTooltip(e) {
            let x = e.clientX + 10, y = e.clientY + 10;
            if (x + 260 > window.innerWidth) x = e.clientX - 270;
            if (y + 120 > window.innerHeight) y = e.clientY - 130;
            dom.tooltip.style.left = x + 'px';
            dom.tooltip.style.top = y + 'px';
        }

        // ========== å³é”®èœå• ==========
        let ctxNodeId = null;

        dom.treeSvg.addEventListener('contextmenu', e => {
            const circle = e.target.closest('.tree-node');
            if (!circle) return;
            e.preventDefault();
            ctxNodeId = circle.dataset.id;

            const node = Tree.getNode(ctxNodeId);
            const items = dom.ctxMenu.querySelectorAll('.ctx-menu__item');

            // åªæœ‰ user èŠ‚ç‚¹æ˜¾ç¤º"é‡æ–°è¾“å…¥"
            items[0].style.display = (node && node.role === 'user') ? 'block' : 'none';

            dom.ctxMenu.style.left = e.clientX + 'px';
            dom.ctxMenu.style.top = e.clientY + 'px';
            dom.ctxMenu.classList.add('visible');
        });

        document.addEventListener('click', () => dom.ctxMenu.classList.remove('visible'));

        dom.ctxMenu.addEventListener('click', e => {
            const action = e.target.dataset.action;
            if (!action || !ctxNodeId) return;

            if (action === 'fork') {
                Tree.forkFrom(ctxNodeId);
            } else if (action === 'edit') {
                const node = Tree.getNode(ctxNodeId);
                if (node) {
                    // ç¼–è¾‘æ¶ˆæ¯å†…å®¹
                    const newContent = prompt('ç¼–è¾‘æ¶ˆæ¯å†…å®¹:', node.text);
                    if (newContent !== null && newContent !== node.text) {
                        node.text = newContent;
                        TreeUI.render();
                        renderMessagesFromTree();
                        // å‘é€ç¼–è¾‘å‘½ä»¤åˆ°åç«¯
                        send(`EDIT_NODE:${ctxNodeId}:${newContent}`);
                    }
                }
            } else if (action === 'delete') {
                // åˆ é™¤æ­¤èŠ‚ç‚¹åŠä¹‹åçš„æ‰€æœ‰èŠ‚ç‚¹
                const node = Tree.getNode(ctxNodeId);
                if (node && confirm('ç¡®å®šåˆ é™¤æ­¤æ¡åŠä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ')) {
                    // ä»æ ‘ä¸­æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹
                    const idx = Tree.nodes.findIndex(n => n.id === ctxNodeId);
                    if (idx >= 0) {
                        Tree.nodes = Tree.nodes.slice(0, idx);
                        // æ›´æ–°activeIdä¸ºå‰ä¸€ä¸ªèŠ‚ç‚¹æˆ–null
                        Tree.activeId = idx > 0 ? Tree.nodes[idx - 1].id : null;
                        TreeUI.render();
                        renderMessagesFromTree();
                        ChatHistory.save();
                        // å‘é€åˆ é™¤å‘½ä»¤åˆ°åç«¯
                        send(`DELETE_FROM:${ctxNodeId}`);
                    }
                }
            }
            dom.ctxMenu.classList.remove('visible');
        });

        // ========== æ¶ˆæ¯æ¸²æŸ“ ==========
        function renderMessagesFromTree() {
            dom.messages.innerHTML = '';
            if (!Tree.activeId) return;
            Tree.getPathTo(Tree.activeId).forEach(node => {
                dom.messages.appendChild(createMsgEl(node.role, node.role === 'user' ? 'USER' : 'PAW', node.text, node.id));
            });
            scrollToBottom();
        }

        // ========== WebSocket ==========
        const ws = new WebSocket(`ws://${location.host}/ws`);
        ws.onopen = () => addSysMsg('Connected to Paw!');
        ws.onclose = () => addSysMsg('Connection closed.', 'error');
        ws.onerror = () => addSysMsg('WebSocket error.', 'error');
        ws.onmessage = e => handleEvent(JSON.parse(e.data));

        function handleEvent({ event, data }) {
            const h = {
                'assistant_stream_start': () => startStream(data.id),
                'assistant_stream_chunk': () => appendStream(data.id, data.text),
                'assistant_stream_end': () => endStream(data.id),
                'tool_start': () => createTool(data),
                'tool_result': () => updateTool(data),
                'system_message': () => addSysMsg(data.text, data.type),
                'status_update': () => updateStatus(data),
                'show_model_selection': () => showModelSelect(data.models),
                'request_input': () => showInputPrompt(data),
                'show_memory': () => Memory.show(data.conversations),
                'memory_result': () => Memory.handleResult(data)
            };
            h[event]?.();
        }

        function send(msg) {
            if (ws.readyState === WebSocket.OPEN) ws.send(msg);
            else addSysMsg('æœªè¿æ¥', 'error');
        }

        // ========== æ¶ˆæ¯å¤„ç† ==========
        let streamId = null, streamBuf = '', pendingUserNodeId = null;

        function addUserMessage(text) {
            // ç¡®å®šçˆ¶èŠ‚ç‚¹ï¼šactiveId åº”è¯¥æ˜¯ assistant èŠ‚ç‚¹æˆ– null
            // å¦‚æœ activeId æŒ‡å‘ user èŠ‚ç‚¹ï¼Œè¯´æ˜é€»è¾‘æœ‰è¯¯ï¼Œåº”è¯¥ç”¨å®ƒçš„çˆ¶èŠ‚ç‚¹
            let parentId = Tree.activeId;
            if (parentId) {
                const activeNode = Tree.getNode(parentId);
                if (activeNode && activeNode.role === 'user') {
                    // ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†åšä¸ªä¿æŠ¤
                    parentId = activeNode.parentId;
                }
            }
            
            const node = Tree.createNode('user', text, parentId);
            pendingUserNodeId = node.id; // è®°å½•è¿™ä¸ª user èŠ‚ç‚¹ï¼Œç­‰ assistant å›å¤æ—¶ç”¨
            TreeUI.render();
            dom.messages.appendChild(createMsgEl('user', 'USER', text, node.id));
            scrollToBottom();
        }

        function startStream(id) {
            streamId = id;
            streamBuf = '';
            dom.messages.appendChild(createMsgEl('assistant', 'PAW', '', id));
        }

        function appendStream(id, text) {
            const content = document.getElementById(id)?.querySelector('.msg__content');
            if (!content) return;
            streamBuf += text;
            content.innerHTML = marked.parse(streamBuf);
            scrollToBottom();
        }

        function endStream(id) {
            const content = document.getElementById(id)?.querySelector('.msg__content');
            if (content) {
                content.querySelectorAll('pre code').forEach(el => {
                    const pre = el.parentElement;
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.textContent = 'Copy';
                    btn.onclick = () => { navigator.clipboard.writeText(el.textContent); btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 2000); };
                    pre.appendChild(btn);
                });
            }
            
            // assistant èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹åº”è¯¥æ˜¯åˆšæ‰çš„ user èŠ‚ç‚¹
            const parentId = pendingUserNodeId || Tree.activeId;
            Tree.createNode('assistant', streamBuf, parentId);
            TreeUI.render();
            
            streamId = null;
            streamBuf = '';
            pendingUserNodeId = null;
        }

        function createMsgEl(type, author, text, id = null) {
            const el = document.createElement('div');
            el.className = `msg msg--${type}`;
            if (id) el.id = id;
            el.innerHTML = `<div class="msg__header">${author}</div><div class="msg__content">${marked.parse(text)}</div>`;
            return el;
        }

        function addSysMsg(text, type = '') {
            const el = document.createElement('div');
            el.className = `sys-msg ${type}`;
            el.textContent = text;
            dom.messages.appendChild(el);
            scrollToBottom();
        }

        function createTool({ id, name, args }) {
            const el = document.createElement('div');
            el.id = `tool-${id}`;
            el.className = 'tool';
            // Shell é£æ ¼ï¼šâ—‹ tool_name args
            el.innerHTML = `<div class="tool__header"><div class="tool__spinner"></div><span class="tool__name">${name}</span> <span class="tool__args">${args}</span></div>`;
            dom.messages.appendChild(el);
            scrollToBottom();
        }

        function updateTool({ id, name, display, success }) {
            const el = document.getElementById(`tool-${id}`);
            if (!el) return;
            el.className = `tool ${success ? 'tool--success' : 'tool--error'}`;

            const line1 = display.line1 || '';
            const line2 = display.line2 || '';
            const hasLine2 = display.has_line2 || false;

            // Header: â— tool_name line1
            let headerHtml = `<span class="tool__icon">â—</span><span class="tool__name">${name}</span> <span class="tool__args">${line1}</span>`;

            // Body: æ¯è¡Œå‰é¢åŠ  â¿
            let bodyHtml = '';
            if (hasLine2 && line2) {
                const lines = line2.split('\n');
                let firstLine = true;
                lines.forEach(line => {
                    // å¦‚æœè¡Œä»¥ â”‚ å¼€å¤´ï¼ˆè¿æ¥çº¿ï¼‰ï¼Œä¿ç•™åŸæ ·
                    if (line.startsWith('â”‚')) {
                        bodyHtml += `<div class="tool__body-line">${escapeHtml(line)}</div>`;
                    } else {
                        // ç¬¬ä¸€è¡Œç”¨ â¿ï¼Œåç»­è¡Œç”¨ç©ºæ ¼å¯¹é½
                        const prefix = firstLine ? 'â¿ ' : '  ';
                        bodyHtml += `<div class="tool__body-line">${prefix}${escapeHtml(line)}</div>`;
                        firstLine = false;
                    }
                });
            }

            el.innerHTML = `<div class="tool__header">${headerHtml}</div>${bodyHtml ? `<div class="tool__body">${bodyHtml}</div>` : ''}`;
        }

        function updateStatus(data) {
            const parts = [];
            if (data.time) parts.push(`time: ${data.time}`);
            if (data.model) parts.push(`model: ${data.model}`);
            if (data.mode) parts.push(`mode: ${data.mode}`);
            dom.statusBar.textContent = parts.join(' Â· ');
        }

        function scrollToBottom() { dom.msgWrap.scrollTop = dom.msgWrap.scrollHeight; }

        // ========== å¼¹çª— ==========
        function showModelSelect(models) {
            dom.modalTitle.textContent = 'é€‰æ‹©æ¨¡å‹';
            dom.modalBody.innerHTML = models.map(m => `<div class="modal__item" data-model="${m}">${m}</div>`).join('');
            dom.modalActions.style.display = 'none';
            dom.modal.classList.add('visible');
        }

        function showInputPrompt(data) {
            dom.modalTitle.textContent = data?.prompt || 'è¾“å…¥';
            dom.modalBody.innerHTML = '<input type="text" class="modal__input" placeholder="è¾“å…¥...">';
            dom.modalActions.style.display = 'flex';
            dom.modal.classList.add('visible');
            setTimeout(() => dom.modalBody.querySelector('input')?.focus(), 30);
        }

        dom.modalBody.addEventListener('click', e => {
            const item = e.target.closest('.modal__item');
            if (item) { send(item.dataset.model); dom.modal.classList.remove('visible'); }
        });

        dom.modalOk.addEventListener('click', () => {
            const v = dom.modalBody.querySelector('input')?.value.trim();
            if (v) { send(v); dom.modal.classList.remove('visible'); }
        });

        // ========== è¾“å…¥ ==========
        function handleSubmit() {
            const msg = dom.input.value.trim();
            if (!msg) return;
            send(msg);
            addUserMessage(msg);
            dom.input.value = '';
            autoResize();
        }

        function autoResize() {
            dom.input.style.height = 'auto';
            dom.input.style.height = dom.input.scrollHeight + 'px';
        }

        dom.form.addEventListener('submit', e => { e.preventDefault(); handleSubmit(); });
        dom.input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSubmit(); } });
        dom.input.addEventListener('input', autoResize);

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== è®°å¿†ç®¡ç† ==========
        const Memory = {
            conversations: [],
            selectedIndex: 0,
            active: false,

            show(conversations) {
                this.conversations = conversations || [];
                this.selectedIndex = 0;
                this.active = true;
                this.render();
                // è‡ªåŠ¨åˆ‡æ¢åˆ°è®°å¿†è§†å›¾
                $$('.sidebar__tab').forEach(t => {
                    t.classList.toggle('sidebar__tab--active', t.dataset.view === 'memory');
                });
                $$('.sidebar__view').forEach(v => v.classList.remove('sidebar__view--active'));
                dom.viewMemory.classList.add('sidebar__view--active');
            },

            hide() {
                this.active = false;
                dom.memoryCanvas.innerHTML = '<div class="memory-empty">/memory æ‰“å¼€è®°å¿†ç®¡ç†</div>';
            },

            render() {
                const count = this.conversations.length;
                dom.memoryStats.textContent = `å…± ${count} æ¡è®°å¿†`;

                if (!count) {
                    dom.memoryCanvas.innerHTML = '<div class="memory-empty">æš‚æ— è®°å¿†</div>';
                    return;
                }

                let html = '';
                this.conversations.forEach((conv, idx) => {
                    const meta = conv.metadata || {};
                    const userMsg = meta.user_message || '';
                    const preview = userMsg.substring(0, 40);
                    const timestamp = meta.timestamp || '';
                    const isActive = idx === this.selectedIndex;
                    html += `
                        <div class="memory-item ${isActive ? 'memory-item--active' : ''}" data-index="${idx}" data-id="${conv.id}">
                            <div class="memory-item__msg">${escapeHtml(preview)}</div>
                            <div class="memory-item__meta">${timestamp.substring(0, 16)}</div>
                            <button class="memory-item__delete" data-delete="${conv.id}">Ã—</button>
                        </div>
                    `;
                });

                dom.memoryCanvas.innerHTML = html;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                dom.memoryCanvas.querySelectorAll('.memory-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.classList.contains('memory-item__delete')) return;
                        const idx = parseInt(e.currentTarget.dataset.index);
                        this.select(idx);
                    });
                });

                // ç»‘å®šåˆ é™¤äº‹ä»¶
                dom.memoryCanvas.querySelectorAll('.memory-item__delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.target.dataset.delete;
                        if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ')) {
                            send(`MEMORY_DELETE:${id}`);
                        }
                    });
                });
            },

            select(idx) {
                this.selectedIndex = idx;
                this.render();

                // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
                const conv = this.conversations[idx];
                if (conv) {
                    this.showDetail(conv);
                }
            },

            showDetail(conv) {
                const meta = conv.metadata || {};
                dom.modalTitle.textContent = 'è®°å¿†è¯¦æƒ…';
                dom.modalBody.innerHTML = `
                    <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem">
                        ID: ${conv.id}<br>
                        é¡¹ç›®: ${meta.project || '(æ— )'}<br>
                        æ—¶é—´: ${meta.timestamp || '(æœªçŸ¥)'}
                    </div>
                    <div style="margin-bottom:0.5rem;color:var(--accent-user)">ç”¨æˆ·:</div>
                    <div style="background:#0d0d0d;padding:0.5rem;border-radius:4px;margin-bottom:0.5rem;max-height:120px;overflow:auto">${escapeHtml(meta.user_message || '(æ— )')}</div>
                    <div style="margin-bottom:0.5rem;color:var(--accent-assistant)">AI:</div>
                    <div style="background:#0d0d0d;padding:0.5rem;border-radius:4px;max-height:120px;overflow:auto">${escapeHtml(meta.assistant_message || '(æ— )')}</div>
                `;
                dom.modalActions.style.display = 'none';
                dom.modal.classList.add('visible');
            },

            search(keyword) {
                send(`MEMORY_SEARCH:${keyword}`);
            },

            clean() {
                if (confirm('ç¡®å®šæ¸…ç†é‡å¤çš„è®°å¿†å—ï¼Ÿ')) {
                    send('MEMORY_CLEAN');
                }
            },

            handleResult(data) {
                if (data.success) {
                    addSysMsg(data.message || 'æ“ä½œæˆåŠŸ');
                    if (data.conversations) {
                        this.conversations = data.conversations;
                        this.render();
                    }
                    // ä¸éšè—è®°å¿†ç®¡ç†ï¼Œç»§ç»­ç¼–è¾‘æ¨¡å¼
                } else {
                    addSysMsg(data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            }
        };

        // è®°å¿†ç®¡ç†å¿«æ·é”®
        dom.input.addEventListener('keydown', e => {
            if (!Memory.active) return;
            if (e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'ArrowUp' || e.key === 'k') {
                e.preventDefault();
                Memory.select(Math.max(0, Memory.selectedIndex - 1));
            } else if (e.key === 'ArrowDown' || e.key === 'j') {
                e.preventDefault();
                Memory.select(Math.min(Memory.conversations.length - 1, Memory.selectedIndex + 1));
            } else if (e.key === 'q' || e.key === 'Q' || e.key === 'Escape') {
                e.preventDefault();
                Memory.hide();
            }
        });

        // è®°å¿†æŒ‰é’®äº‹ä»¶
        dom.memorySearchBtn.addEventListener('click', () => {
            const keyword = prompt('è¾“å…¥æœç´¢å…³é”®è¯:');
            if (keyword) Memory.search(keyword);
        });

        dom.memoryCleanBtn.addEventListener('click', () => {
            Memory.clean();
        });

        // ========== å¯åŠ¨ ==========
        addSysMsg('Waiting for Paw...');
        autoResize();
        ChatHistory.init();
    </script>
</body>
</html>
